<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<!-- Stop iOS from auto-linking addresses/phones/emails -->
<meta name="format-detection" content="telephone=no,address=no,email=no">
<title>SF Speed Cameras - Alerts & Map</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Defer for performance -->
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- Preload nag VO -->
<link rel="preload" as="audio" href="images/audio/Ad1.mp3" type="audio/mpeg">

<style>
  :root{
    --paid-offset-mobile: 220px;
    --paid-offset-desktop: 330px;
    --overlay-top: 10px;
    --shell-max: 520px;
    --overlay-paid-offset: -12px; /* tweak here if you want ± px */
  }
  html, body { height:100%; }
  body{
    margin:0; background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Arial; font-weight:600;
    display:flex; flex-direction:column; overflow-x:hidden;
  }
  .page { flex:1 0 auto; position:relative; }
  footer { flex:0 0 auto; padding:14px 0 calc(18px + env(safe-area-inset-bottom)); text-align:center; }

  /* Background video */
  .video-bg{ position:fixed; left:0; top:0; width:100vw; height:100dvh; z-index:-3; overflow:hidden; }
  .video-bg video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center center; }

  /* Overlay art */
  .overlay-layer{
    position:absolute; left:0; top:var(--overlay-top); width:100%; z-index:2; pointer-events:none;
  }
  .overlay-layer img{ width:100%; height:auto; display:block; }
  #overlay-paid{ transform:translateY(var(--overlay-paid-offset)); }

  /* Content under PNG */
  .content-wrap{ position:relative; padding:16px 20px 24px; z-index:3; margin-top:var(--paid-offset-mobile); }
  @media (min-width:1200px){ .content-wrap{ margin-top:var(--paid-offset-desktop);} }

  .app-shell{ width:min(92vw, var(--shell-max)); margin:0 auto; }

  .btn-match{ line-height:1.25; padding:.55rem 1rem; font-weight:700; }
  #warmup.btn-off   { background:#b02a37; border-color:#b02a37; color:#fff; }
  #warmup.btn-on    { background:#198754; border-color:#198754; color:#fff; }
  #warmup.btn-mute  { background:#b89b00; border-color:#b89b00; color:#111; }

  /* Map/list */
  #map{ height:60vh; border:1px solid #ddd; border-radius:8px; background:rgba(255,255,255,.85); }
  @media (max-width:1200px){ #map{ height:50vh; } }
  .camera-list{ max-height:200px; overflow-y:auto; }

  /* Phone-specific tightening */
  @media (max-width:430px){
    #map{ height:52vh; }
    .camera-list{ max-height:180px; }
    .content-wrap{ margin-top:200px; }
  }

  /* User dot */
  .loc-dot{ width:14px; height:14px; border-radius:50%; background:#2a6bf4; border:2px solid #fff; box-shadow:0 0 0 6px rgba(42,107,244,.25); }

  /* SPEED LIMIT sign */
  .speed-sign { position:fixed; left:50%; top:12px; transform:translateX(-50%) translateY(-20px); z-index:50; pointer-events:none; opacity:0; transition:opacity .2s, transform .25s; }
  .speed-sign.show { opacity:1; transform:translateX(-50%) translateY(0); }
  .speed-sign .sign{ background:#fff; color:#000; border:4px solid #000; border-radius:10px; width:min(46vw, 280px); padding:10px 14px 12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .speed-sign .label{ font-weight:800; letter-spacing:.06em; text-align:center; font-size:14px; margin-bottom:4px; }
  .speed-sign .value{ font-weight:900; text-align:center; font-size:clamp(56px, 16vw, 110px); line-height:1; }
  .speed-sign .capsule{ margin-top:8px; text-align:center; font-size:12px; font-weight:700; letter-spacing:.04em; color:#111; background:#eee; border-radius:999px; padding:4px 10px; display:none; }
  .speed-sign.unknown .capsule{ display:inline-block; }

  /* Trial nag */
  .nag-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:60; }
  .nag-wrap{ position:relative; transform:translateY(30px); }
  .nag-img{ max-width:min(90vw, 540px); border-radius:14px; box-shadow:0 25px 60px rgba(0,0,0,.55); }
  .nag-count{ position:absolute; bottom:10px; right:14px; background:rgba(0,0,0,.6); color:#fff; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; }

  /* Prevent accidental address link styling */
  .leaflet-popup-content a{ text-decoration:none; pointer-events:none; color:inherit; }
</style>
</head>
<body>
  <!-- Background video (path uses BASE, fixed) -->
  <div class="video-bg">
    <video id="bgvid" autoplay loop muted playsinline poster="https://via.placeholder.com/1920x1080?text=Loading+Video">
      <source id="bgvidSrc" src="" type="video/mp4">
    </video>
  </div>

  <!-- Overlay PNGs -->
  <div class="overlay-layer" id="overlay">
    <picture id="overlay-paid">
      <source id="ovPaidSrcM" media="(max-width: 1200px)" srcset="">
      <img id="ovPaidImg" src="" alt="SF Speed Cameras (Paid)">
    </picture>
  </div>

  <!-- Page -->
  <div class="page">
    <div class="content-wrap">
      <div class="app-shell">
        <!-- Controls row -->
        <div class="d-flex gap-2 align-items-center mb-3">
          <a id="payCTA" class="btn btn-primary btn-match" href="#" role="button">Go Pro</a>
          <button id="warmup" class="btn btn-match btn-off" aria-pressed="false">Sound &amp; GPS: Off</button>
        </div>

        <!-- Map -->
        <div id="map" class="mb-3" tabindex="-1"></div>

        <!-- Camera List -->
        <div id="list" class="card mb-3">
          <div class="card-header">Camera Locations</div>
          <ul class="list-group camera-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- SPEED LIMIT sign -->
  <div id="speedSign" class="speed-sign" aria-live="polite" hidden>
    <div class="sign">
      <div class="label">SPEED LIMIT</div>
      <div class="value" id="speedLimitValue">--</div>
      <div class="capsule">SPEED CAMERA ZONE</div>
    </div>
  </div>

  <!-- Trial Nag -->
  <div id="nag" class="nag-backdrop">
    <div class="nag-wrap">
      <img id="nagImg" class="nag-img" src="" alt="Upgrade prompt">
      <div id="nagCountdown" class="nag-count">25</div>
    </div>
  </div>

  <footer>
    <small>&copy; 2025 SF Speed Cameras • <a href="#" class="text-white-50">Privacy</a> • <a href="#" class="text-white-50">Contact</a></small>
  </footer>

<script>
/* ===== Bootstrapping ===== */
window.addEventListener('DOMContentLoaded', () => {
  try { history.scrollRestoration = 'manual'; } catch {}
  if (location.hash) { history.replaceState(null, '', location.pathname); }
  window.addEventListener('load', () => { window.scrollTo(0, 0); if (document.activeElement) document.activeElement.blur(); });

  /* Base path for GitHub Pages */
  const REPO = 'sf-speed-alerts';
  const BASE = location.pathname.startsWith('/' + REPO) ? ('/' + REPO) : '';
  const DATA_BASE = `${BASE}/data`; // <-- point to /data

  /* Set media + overlay assets with BASE */
  document.getElementById('bgvidSrc').src = `${BASE}/videos/background.mp4`;
  document.getElementById('ovPaidSrcM').srcset = `${BASE}/images/Copyblockmobile_paid.png`;
  document.getElementById('ovPaidImg').src     = `${BASE}/images/Copyblockdesktop_paid.png`;

  /* Stripe */
  const STRIPE_URL = "https://buy.stripe.com/eVq4gA1ra1ptdAT1ZQfbq01";
  document.getElementById('payCTA').addEventListener('click', (e)=>{ e.preventDefault(); window.open(STRIPE_URL, '_blank', 'noopener'); });

  /* Fit background container height */
  const bg = document.getElementById('bgvid');
  bg?.addEventListener('ended', ()=>{ try{ bg.currentTime = 0; bg.play(); }catch(e){} }, false);
  function sizeBG(){ const el=document.querySelector('.video-bg'); if(!el) return; el.style.height = window.innerHeight + 'px'; }
  addEventListener('resize', sizeBG); addEventListener('orientationchange', sizeBG); sizeBG();

  /* ===== Cameras (names for list, voice, geofence) ===== */
  const cameras = [
    {name:"Fulton Street from 42nd to 43rd Ave",lat:37.7725,lon:-122.5015},
    {name:"Lincoln Way from 27th to 28th Ave",lat:37.7658,lon:-122.4860},
    {name:"Geary Blvd from 7th to 8th Ave",lat:37.7805,lon:-122.4660},
    {name:"Fulton St from 2nd Ave to Arguello Blvd",lat:37.7735,lon:-122.4550},
    {name:"Geary Blvd from Webster to Buchanan St",lat:37.7845,lon:-122.4310},
    {name:"Turk St from Van Ness Ave to Polk St",lat:37.7820,lon:-122.4195},
    {name:"Bay St from Octavia to Gough St",lat:37.8040,lon:-122.4230},
    {name:"Franklin St from Union to Green St",lat:37.8000,lon:-122.4235},
    {name:"Columbus Ave from Lombard to Greenwich St",lat:37.8025,lon:-122.4135},
    {name:"Broadway from Powell to Stockton St",lat:37.7975,lon:-122.4075},
    {name:"The Embarcadero from Green to Battery St",lat:37.8070,lon:-122.4005},
    {name:"Mission St from 8th to 9th St",lat:37.7740,lon:-122.4110},
    {name:"10th St from Harrison to Folsom St",lat:37.7715,lon:-122.4115},
    {name:"9th St from Bryant to Harrison St",lat:37.7725,lon:-122.4090},
    {name:"7th St from Harrison to Folsom St",lat:37.7745,lon:-122.4065},
    {name:"Harrison St from 4th to 5th St",lat:37.7795,lon:-122.4015},
    {name:"Bryant St from 2nd to 3rd St",lat:37.7820,lon:-122.3965},
    {name:"King St (EB only) from 4th to 5th St",lat:37.7775,lon:-122.3940},
    {name:"Market St from Danvers to Douglass St",lat:37.7615,lon:-122.4320},
    {name:"Guerrero St from 19th to 20th St",lat:37.7590,lon:-122.4230},
    {name:"16th St from Bryant St to Potrero Ave",lat:37.7650,lon:-122.4075},
    {name:"San Jose Ave from 29th to 30th St",lat:37.7435,lon:-122.4235},
    {name:"Cesar Chavez St from Folsom to Harrison St",lat:37.7480,lon:-122.4035},
    {name:"Cesar Chavez St from Indiana to Tennessee St",lat:37.7505,lon:-122.3900},
    {name:"3rd St (NB only) from Key to Jamestown Ave",lat:37.7275,lon:-122.3885},
    {name:"Bayshore Blvd (SB only) from 101 off-ramp to Tunnel Ave",lat:37.7100,lon:-122.3990},
    {name:"Geneva Ave from Prague St to Brookdale Ave",lat:37.7130,lon:-122.4405},
    {name:"Mission St from Ottawa Ave to Allison St",lat:37.7145,lon:-122.4400},
    {name:"Alemany Blvd from Farragut to Naglee Ave",lat:37.7320,lon:-122.4425},
    {name:"Ocean Ave from Frida Kahlo Way to Howth St",lat:37.7235,lon:-122.4525},
    {name:"San Jose Ave from Santa Ynez to Ocean Ave",lat:37.7280,lon:-122.4430},
    {name:"Monterey Blvd from Edna to Congo St",lat:37.7315,lon:-122.4650},
    {name:"Sloat Blvd from 41st Ave to Skyline Blvd",lat:37.7355,lon:-122.4980}
  ];

  /* ===== Map ===== */
  let map, userMarker;
  const poleLayer = L.layerGroup();
  const areaLayer = L.layerGroup();

  function initMap(){
    map = L.map('map',{ zoomControl:true }).setView([37.7749,-122.4194],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(map);
    poleLayer.addTo(map);
    areaLayer.addTo(map);

    // List (center + speak on click)
    const ul = document.querySelector('.camera-list');
    if (ul){
      cameras.forEach(c=>{
        const li=document.createElement('li');
        li.className='list-group-item';
        li.textContent=c.name;
        li.addEventListener('click',()=>{ map.setView([c.lat,c.lon],15); playLocationOnly(c.name); });
        ul.appendChild(li);
      });
    }

    const dot = L.divIcon({ className:'loc-dot' });
    userMarker = L.marker([37.7749,-122.4194],{icon:dot});
  }

  /* ===== Audio unlock & playback ===== */
  const AUDIO_BASE = `${BASE}/images/audio/`;
  const AudioUnlock = (() => {
    let ctx = null, unlocked = false;
    async function unlock(){
      if (unlocked) return true;
      try{
        ctx = ctx || new (window.AudioContext||window.webkitAudioContext)();
        await ctx.resume();
        const b = ctx.createBuffer(1, 1, ctx.sampleRate);
        const s = ctx.createBufferSource(); s.buffer = b; s.connect(ctx.destination); s.start(0);
        unlocked = true;
      }catch{}
      return unlocked;
    }
    // unlock on first touch/click
    window.addEventListener('pointerdown', () => unlock(), { once:true });
    return { unlock, get unlocked(){ return unlocked; }, get ctx(){ return ctx; } };
  })();

  let player = new Audio();
  async function playNow(url){
    await AudioUnlock.unlock();
    try { player.pause(); } catch {}
    return new Promise((resolve) => {
      player = new Audio(url);
      player.onended = resolve;
      player.onerror = resolve;
      player.play().catch(()=>{ resolve(); });
    });
  }

  const STEMS = Array.from({length:11},(_,i)=>`speed_camera_ahead_${i+1}.mp3`);
  const TAGS = [
    'brake_the_habit.mp3','this_picture_is_not_for_the_gram.mp3','your_wallet_just_got_a_little_nervous.mp3',
    'no_need_for_a_photo_finish.mp3','your_best_pose_is_slow.mp3','they_go_high_we_go_slow.mp3',
    'keep_it_chill_avoid_the_bill.mp3','slow_is_the_new_fast.mp3','pace_yourself.mp3',
    'less_gas_more_class.mp3','the_smart_money_is_on_slowing_down.mp3','avoid_the_money_shot.mp3',
    'chill_now_thank_yourself_later.mp3','no_rush_no_fuss.mp3','easy_does_it.mp3',
    'save_the_drama_for_the_drivethru.mp3','your_brakes_called_they_are_ready_to_help.mp3',
    'lets_keep_your_record_clean_ish.mp3','slow_jams_only.mp3','brake_it_till_you_make_it.mp3',
    'slow_and_easy_hotshot.mp3','the_only_rush_is_in_your_head.mp3','drive_like_someone_is_watching.mp3',
    'give_those_brakes_a_little_love.mp3','slow_is_the_flex.mp3','Your_future_self_says_thanks.mp3',
    'brakes_are_a_good_good_friend.mp3'
  ];
  const LOC = {
    "Fulton Street from 42nd to 43rd Ave":"fulton_street_from_42nd_to_43rd_ave.mp3",
    "Lincoln Way from 27th to 28th Ave":"lincoln_way_from_27th_to_28th_ave.mp3",
    "Geary Blvd from 7th to 8th Ave":"geary_blvd_from_7th_to_8th_ave.mp3",
    "Fulton St from 2nd Ave to Arguello Blvd":"fulton_st_from_2nd_ave_to_arguello_blvd.mp3",
    "Geary Blvd from Webster to Buchanan St":"geary_blvd_from_webster_to_buchanan_st.mp3",
    "Turk St from Van Ness Ave to Polk St":"turk_st_from_van_ness_ave_to_polk_st.mp3",
    "Bay St from Octavia to Gough St":"bay_st_from_octavia_to_gough_st.mp3",
    "Franklin St from Union to Green St":"franklin_st_from_union_to_green_st.mp3",
    "Columbus Ave from Lombard to Greenwich St":"columbus_ave_from_lombard_to_greenwich_st.mp3",
    "Broadway from Powell to Stockton St":"broadway_from_powell_to_stockton_st.mp3",
    "The Embarcadero from Green to Battery St":"the_embarcadero_from_green_to_battery_st.mp3",
    "Mission St from 8th to 9th St":"mission_st_from_8th_to_9th_st.mp3",
    "10th St from Harrison to Folsom St":"10th_st_from_harrison_to_folsom_st.mp3",
    "9th St from Bryant to Harrison St":"9th_st_from_bryant_to_harrison_st.mp3",
    "7th St from Harrison to Folsom St":"7th_st_from_harrison_to_folsom_st.mp3",
    "Harrison St from 4th to 5th St":"harrison_st_from_4th_to_5th_st.mp3",
    "Bryant St from 2nd to 3rd St":"bryant_st_from_2nd_to_3rd_st.mp3",
    "King St (EB only) from 4th to 5th St":"king_st_eb_only_from_4th_to_5th_st.mp3",
    "Market St from Danvers to Douglass St":"market_st_from_danvers_to_douglass_st.mp3",
    "Guerrero St from 19th to 20th St":"guerrero_st_from_19th_to_20th_st.mp3",
    "16th St from Bryant St to Potrero Ave":"16th_st_from_bryant_st_to_potrero_ave.mp3",
    "San Jose Ave from 29th to 30th St":"san_jose_ave_from_29th_to_30th_st.mp3",
    "Cesar Chavez St from Folsom to Harrison St":"cesar_chavez_st_from_folsom_to_harrison_st.mp3",
    "Cesar Chavez St from Indiana to Tennessee St":"cesar_chavez_st_from_indiana_to_tennessee_st.mp3",
    "3rd St (NB only) from Key to Jamestown Ave":"3rd_st_nb_only_from_key_to_jamestown_ave.mp3",
    "Bayshore Blvd (SB only) from 101 off-ramp to Tunnel Ave":"bayshore_blvd_sb_only_from_101_off_ramp_to_tunnel_ave.mp3",
    "Geneva Ave from Prague St to Brookdale Ave":"geneva_ave_from_prague_st_to_brookdale_ave.mp3",
    "Mission St from Ottawa Ave to Allison St":"mission_st_from_ottawa_ave_to_allison_st.mp3",
    "Alemany Blvd from Farragut to Naglee Ave":"alemany_blvd_from_farragut_to_naglee_ave.mp3",
    "Ocean Ave from Frida Kahlo Way to Howth St":"ocean_ave_from_frida_kahlo_way_to_howth_st.mp3",
    "San Jose Ave from Santa Ynez to Ocean Ave":"san_jose_ave_from_santa_ynez_to_ocean_ave.mp3",
    "Monterey Blvd from Edna to Congo St":"monterey_blvd_from_edna_to_congo_st.mp3",
    "Sloat Blvd from 41st Ave to Skyline Blvd":"sloat_blvd_from_41st_ave_to_skyline_blvd.mp3"
  };
  function pick(a){return a[Math.floor(Math.random()*a.length)]}
  function playLocationOnly(name){ const f=LOC[name]; if(f) playNow(`${AUDIO_BASE}${f}`); }

  /* ===== Fetch helpers ===== */
  function bust(url){ const sep = url.includes('?') ? '&' : '?'; return `${url}${sep}v=${Date.now()}`; }
  async function fetchJSON(url){
    const r = await fetch(bust(url), { cache:'no-store' });
    if (!r.ok) throw new Error(`Fetch failed ${url}: ${r.status}`);
    return r.json();
  }

  /* ===== Polygons (from corridors.json already filtered) ===== */
  const CORRIDORS_URL = `${DATA_BASE}/corridors.json`;
  const POLY_STYLE = { color:'#1e88e5', weight:1.5, opacity:0.9, fillColor:'#1e88e5', fillOpacity:0.18 };

  async function addCorridors(){
    try{
      const fc = await fetchJSON(CORRIDORS_URL);
      (fc.features||[]).forEach(f=>{
        const nm = f.properties?.CORRIDOR || f.properties?.Name || f.properties?.Segment || null;
        const layer = L.geoJSON(f, { style: POLY_STYLE }).addTo(areaLayer);
        layer.bindPopup(nm || 'Approach Area');

        // Block any accidental link clicks in the popup (iOS data detectors)
        layer.on('popupopen', e=>{
          const el = e.popup.getElement();
          if (!el) return;
          el.querySelectorAll('a').forEach(a=>{
            a.addEventListener('click', ev=>ev.preventDefault());
          });
        });

        // Click polygon to speak
        layer.on('click', () => {
          if (nm && LOC[nm]) {
            playLocationOnly(nm);
          } else {
            const c = turf.center(f)?.geometry?.coordinates;
            if (Array.isArray(c)) {
              const nearest = nearestCameraName(c[1], c[0]);
              if (nearest) playLocationOnly(nearest);
            }
          }
        });
      });
    }catch(e){ console.warn('Corridors load failed', e); }
  }

  /* ===== Poles (from allpoles.json cleaned & deduped) ===== */
  const POLES_URL = `${DATA_BASE}/allpoles.json`;

  function toRad(d){return d*Math.PI/180}
  function distKm(aLat,aLon,bLat,bLon){
    const R=6371,dLat=toRad(bLat-aLat),dLon=toRad(bLon-aLon);
    const s=Math.sin(dLat/2)**2+Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
  }
  function nearestCameraName(lat, lon){
    let best=null, bestD=Infinity;
    for (const c of cameras){
      const d = distKm(lat, lon, c.lat, c.lon);
      if (d < bestD){ bestD = d; best = c.name; }
    }
    return best;
  }

  async function addPoleMarkers(){
    const camIcon = L.icon({
      iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><circle cx="14" cy="14" r="10" fill="#d62828" stroke="white" stroke-width="3"/></svg>'),
      iconSize:[28,28], iconAnchor:[14,14]
    });

    try{
      const fc = await fetchJSON(POLES_URL);
      const feats = (fc.features||[]).filter(f=>{
        try{ const [x,y]=f.geometry.coordinates; return x>-124&&x<-121&&y>37&&y<38; }catch{return false}
      });

      // De-dupe ~1m
      const seen=new Set(), clean=[];
      for(const f of feats){
        const [x,y]=f.geometry.coordinates;
        const k=`${(+x).toFixed(5)},${(+y).toFixed(5)}`;
        if(!seen.has(k)){ seen.add(k); clean.push(f); }
      }

      const latlngs=[];
      clean.forEach(f=>{
        const [lng,lat]=f.geometry.coordinates;
        const name = nearestCameraName(lat, lng);
        const m = L.marker([lat,lng],{icon:camIcon}).addTo(poleLayer);
        // Use a DOM node to avoid any auto-link behavior
        const div = document.createElement('div'); div.textContent = name || 'Speed Camera';
        m.bindPopup(div);
        m.on('click', ()=>{ if(name) playLocationOnly(name); });
        latlngs.push([lat,lng]);
      });

      if(latlngs.length){ map.fitBounds(L.latLngBounds(latlngs).pad(0.2)); }
    }catch(e){
      console.warn('Failed to load allpoles.json:', e);
    }
  }

  /* ===== Speed sign & geofence (unchanged functional) ===== */
  const SPEED_LIMITS = {};
  function showSpeedSign(limit){
    const box = document.getElementById('speedSign'); const val = document.getElementById('speedLimitValue');
    if (!box || !val) return;
    if (Number.isFinite(limit)){ val.textContent = String(limit); box.classList.remove('unknown'); }
    else { val.textContent = '--'; box.classList.add('unknown'); }
    box.hidden = false; box.classList.add('show');
  }
  function hideSpeedSign(){ const box=document.getElementById('speedSign'); if(!box) return; box.classList.remove('show'); setTimeout(()=>{box.hidden=true;},250); }

  const ENTER_M = 35, EXIT_M = 55, MAX_ACC_M = 30, MIN_SPEED_MPS = 2.2, COOLDOWN_MS = 45000;
  const insideNow = new Set(), lastAlertAt = new Map();

  function passesGates(coords){
    const {accuracy,speed}=coords;
    if(accuracy && accuracy>MAX_ACC_M) return false;
    if(typeof speed==='number' && speed<MIN_SPEED_MPS) return false;
    return true;
  }

  function startGPS(){
    if(!('geolocation' in navigator)) return;
    if(window.__watchId!=null) return;
    if (!map.hasLayer(userMarker)) userMarker.addTo(map);

    window.__watchId = navigator.geolocation.watchPosition(async pos=>{
      const {latitude,longitude} = pos.coords;
      if(!passesGates(pos.coords)) return;

      userMarker.setLatLng([latitude,longitude]);

      const now=Date.now();
      for(const cam of cameras){
        const dM = distKm(latitude, longitude, cam.lat, cam.lon)*1000;
        const inZone = dM <= ENTER_M, wasIn = insideNow.has(cam.name);

        if(!wasIn && inZone){
          const last = lastAlertAt.get(cam.name)||0;
          if(now-last>COOLDOWN_MS){
            playGeofenceAlert(cam.name);
            showSpeedSign(SPEED_LIMITS[cam.name]);
            lastAlertAt.set(cam.name, now);
          }
          insideNow.add(cam.name);
        } else if (wasIn && dM > EXIT_M){
          insideNow.delete(cam.name);
          hideSpeedSign();
        }
      }
    }, err=>console.warn('Geolocation error', err),
    { enableHighAccuracy:true, maximumAge:500, timeout:8000 });
  }
  function stopGPS(){
    if (window.__watchId!=null){ navigator.geolocation.clearWatch(window.__watchId); window.__watchId=null; }
    try{ map.removeLayer(userMarker); }catch{}
    insideNow.clear();
    hideSpeedSign();
  }

  /* ===== Sound & GPS button (also unlocks audio) ===== */
  const warmBtn = document.getElementById('warmup');
  let mode = 'off';
  function applyMode(){
    warmBtn.classList.remove('btn-off','btn-on','btn-mute');
    if(mode==='off'){ warmBtn.classList.add('btn-off'); warmBtn.textContent='Sound & GPS: Off'; stopGPS(); }
    if(mode==='on'){  warmBtn.classList.add('btn-on');  warmBtn.textContent='Sound & GPS: On';  startGPS(); }
    if(mode==='mute'){warmBtn.classList.add('btn-mute');warmBtn.textContent='Mute: GPS Only';   startGPS(); }
  }
  warmBtn.addEventListener('click', async ()=>{
    await AudioUnlock.unlock(); // this tap doubles as unlock
    mode = (mode==='off') ? 'on' : (mode==='on' ? 'mute' : 'off');
    applyMode();
  });
  applyMode();

  /* ===== Trial Nag every 15 min ===== */
  const NAG_FIRST_MS  = 120000;
  const NAG_REPEAT_MS = 15*60*1000;
  const NAG_IMAGES = [ `${BASE}/images/Ad1.png`, `${BASE}/images/Ad2.png` ];
  const NAG_AUDIO_URL = `${BASE}/images/audio/Ad1.mp3`;

  const nagEl  = document.getElementById('nag');
  const nagImg = document.getElementById('nagImg');
  const nagCount = document.getElementById('nagCountdown');
  const nagAudio = new Audio(NAG_AUDIO_URL); nagAudio.preload = 'auto'; nagAudio.crossOrigin = 'anonymous';

  let nagPlaying = false;
  let nagBuffer = null;
  let nagBufferReady = false;

  function blockPage(){ document.body.style.pointerEvents = 'none'; nagEl.style.pointerEvents = 'none'; }
  function unblockPage(){ document.body.style.pointerEvents = '';   nagEl.style.pointerEvents = 'auto'; }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  let geofencePlaying = false; // declared ahead for wait function

  async function ensureNagBuffer(){
    if (nagBufferReady) return nagBuffer;
    try{
      const res = await fetch(bust(NAG_AUDIO_URL), { cache:'force-cache' });
      const ab = await res.arrayBuffer();
      await AudioUnlock.unlock();
      const ctx = AudioUnlock.ctx;
      nagBuffer = await ctx.decodeAudioData(ab);
      nagBufferReady = true;
    }catch(e){ nagBufferReady = false; }
    return nagBuffer;
  }
  async function playNagWebAudio(){
    const buf = await ensureNagBuffer();
    if (!buf) throw new Error('no-buffer');
    const ctx = AudioUnlock.ctx;
    return new Promise(resolve=>{
      const src = ctx.createBufferSource();
      src.buffer = buf;
      src.connect(ctx.destination);
      src.onended = resolve;
      try { src.start(0); } catch { resolve(); }
    });
  }
  async function playNagAudioFallback(){
    await AudioUnlock.unlock();
    try { nagAudio.pause(); } catch {}
    try { nagAudio.currentTime = 0; } catch {}
    try { nagAudio.load(); } catch {}
    try { await nagAudio.play(); }
    catch {
      await sleep(300);
      try { await nagAudio.play(); }
      catch {
        nagEl.style.pointerEvents = 'auto';
        nagEl.onclick = async (ev)=>{
          ev.stopPropagation();
          nagEl.onclick = null;
          try { await AudioUnlock.unlock(); } catch {}
          try { await playNagWebAudio(); }
          catch { await playNagAudioFallback(); await new Promise(res => { nagAudio.onended = res; }); }
          finishNag();
        };
      }
    }
  }

  async function showNag(){
    if (nagPlaying) return;
    nagPlaying = true;

    nagImg.src = NAG_IMAGES[Math.floor(Math.random()*NAG_IMAGES.length)];
    nagEl.style.display = 'flex';
    blockPage();

    let left = 25;
    nagCount.textContent = left;
    const timer = setInterval(()=>{ left = Math.max(0, left-1); nagCount.textContent = left; }, 1000);
    const metaHandler = () => {
      if (isFinite(nagAudio.duration) && nagAudio.duration > 1) {
        left = Math.ceil(nagAudio.duration);
        nagCount.textContent = left;
      }
      nagAudio.removeEventListener('loadedmetadata', metaHandler);
    };
    nagAudio.addEventListener('loadedmetadata', metaHandler);

    try { await playNagWebAudio(); }
    catch { await playNagAudioFallback(); await new Promise(res => { nagAudio.onended = res; }); }

    finishNag();
    function finishNag(){
      clearInterval(timer);
      nagCount.textContent = '0';
      nagEl.onclick = () => { nagEl.style.display='none'; };
      nagImg.onclick = () => { window.open(STRIPE_URL, '_blank', 'noopener'); nagEl.style.display='none'; };
      unblockPage();
      setTimeout(()=>{ if(nagEl.style.display==='flex'){ nagEl.style.display='none'; } }, 8000);
      nagPlaying = false;
    }
  }
  setTimeout(showNag, NAG_FIRST_MS);
  setInterval(showNag, NAG_REPEAT_MS);

  /* ===== Geofence alert chain (uses voice stems + location + tag) ===== */
  async function playGeofenceAlert(name){
    const f=LOC[name]; if(!f) return;
    geofencePlaying = true;
    try{
      const seq = [ `${AUDIO_BASE}${pick(STEMS)}`, `${AUDIO_BASE}${f}`, `${AUDIO_BASE}${pick(TAGS)}` ];
      for (const url of seq){ await playNow(url); }
    } finally { geofencePlaying = false; }
    if(navigator.vibrate) navigator.vibrate([250,100,250]);
  }

  /* ===== Start everything ===== */
  initMap();
  Promise.all([ addCorridors(), addPoleMarkers() ]).then(()=>{
    // gentle audio preload
    setTimeout(()=>{ preloadAudioList(buildAudioUrls(), 4); }, 300);
  });

  /* ===== Preloader ===== */
  function buildAudioUrls(){
    const urls = [];
    for (const s of STEMS) urls.push(`${AUDIO_BASE}${s}`);
    for (const t of TAGS)  urls.push(`${AUDIO_BASE}${t}`);
    Object.values(LOC).forEach(f => urls.push(`${AUDIO_BASE}${f}`));
    return urls;
  }
  async function preloadAudioList(urls, concurrency=4){
    const queue = [...urls];
    const workers = Array.from({length:concurrency}, async ()=>{
      while(queue.length){
        const url = queue.shift();
        try{ const a=new Audio(); a.preload='auto'; a.src=url; a.load(); await new Promise(r=>setTimeout(r,60)); }catch(e){}
      }
    });
    await Promise.all(workers);
  }

}); // DOMContentLoaded
</script>
</body>
</html>
