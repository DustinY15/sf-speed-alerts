<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SF Speed Cameras - Alerts & Map</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- Stripe warmup -->
<link rel="preconnect" href="https://buy.stripe.com" crossorigin>
<link rel="dns-prefetch" href="https://buy.stripe.com">

<style>
  :root{
    /* How far main content sits under the paid PNGs */
    --paid-offset-mobile: 260px;
    --paid-offset-desktop: 330px;

    /* PNG top inset */
    --overlay-top: 10px;
  }

  html, body { height:100%; }
  body{
    margin:0; background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Arial; font-weight:600;
    display:flex; flex-direction:column; overflow-x:hidden;
  }
  .page { flex:1 0 auto; position:relative; }
  footer { flex:0 0 auto; padding:14px 0 18px; text-align:center; }

  /* Background video */
  .video-bg{ position:fixed; left:0; top:0; width:100vw; height:100dvh; z-index:-3; overflow:hidden; }
  .video-bg video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center center; }

  /* Overlay PNGs (not clickable, layer above video) */
  .overlay-layer{ position:absolute; left:0; top:var(--overlay-top); width:100%; z-index:2; pointer-events:none; }
  .overlay-layer img{ width:100%; height:auto; display:block; }

  /* Content under PNG */
  .content-wrap{ position:relative; padding:16px 20px 24px; z-index:1; }
  body.paid .content-wrap{ margin-top:var(--paid-offset-mobile); }
  @media (min-width:1200px){ body.paid .content-wrap{ margin-top:var(--paid-offset-desktop);} }

  /* Map/list */
  #map{ height:60vh; border:1px solid #ddd; border-radius:8px; background:rgba(255,255,255,.85); }
  @media (max-width:1200px){ #map{ height:50vh; } }
  .camera-list{ max-height:200px; overflow-y:auto; }

  /* 3-state Sound/GPS button */
  #soundGps.btn-off{ background:#6c757d; border-color:#6c757d; color:#fff; }   /* Off = gray */
  #soundGps.btn-gps{ background:#ffc107; border-color:#ffc107; color:#111; }  /* GPS only (muted) = yellow */
  #soundGps.btn-on { background:#28a745; border-color:#28a745; color:#fff; }  /* On = green */

  /* Follow toggle */
  #followMe.btn-on{ background:#0dcaf0; border-color:#0dcaf0; color:#111; }

  /* SPEED LIMIT sign */
  .speed-sign { position:fixed; left:50%; top:12px; transform:translateX(-50%) translateY(-20px); z-index:50; pointer-events:none; opacity:0; transition:opacity .2s, transform .25s; }
  .speed-sign.show { opacity:1; transform:translateX(-50%) translateY(0); }
  .speed-sign .sign{ background:#fff; color:#000; border:4px solid #000; border-radius:10px; width:min(46vw, 280px); padding:10px 14px 12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .speed-sign .label{ font-weight:800; letter-spacing:.06em; text-align:center; font-size:14px; margin-bottom:4px; }
  .speed-sign .value{ font-weight:900; text-align:center; font-size:clamp(56px, 16vw, 110px); line-height:1; }
  .speed-sign .capsule{ margin-top:8px; text-align:center; font-size:12px; font-weight:700; letter-spacing:.04em; color:#111; background:#eee; border-radius:999px; padding:4px 10px; display:none; }
  .speed-sign.unknown .capsule{ display:inline-block; }

  /* Promo / Ad modals */
  .promo-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; z-index:1000;
  }
  .promo-overlay.show{ display:flex; }
  .promo-card{
    position:relative; width:min(92vw, 600px); max-height:86vh;
    border-radius:14px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.6);
    background:#111;
  }
  .promo-card img{ width:100%; height:auto; display:block; }
  .promo-controls{
    position:absolute; bottom:10px; left:0; right:0; display:flex; gap:10px; justify-content:center;
  }
  .promo-btn{
    border:none; border-radius:999px; padding:10px 16px; font-weight:700; cursor:pointer;
    box-shadow:0 4px 16px rgba(0,0,0,.35);
  }
  .promo-primary{ background:#0d6efd; color:#fff; }
  .promo-ghost{ background:rgba(255,255,255,.88); color:#111; }
  .promo-close{
    position:absolute; top:8px; right:8px; width:36px; height:36px; border-radius:999px; border:none;
    background:rgba(0,0,0,.5); color:#fff; font-size:20px; line-height:0; cursor:pointer;
  }
  .promo-badge{
    position:absolute; top:8px; left:8px; background:#ffc107; color:#111; font-weight:800; border-radius:6px; padding:6px 10px; font-size:12px;
  }
</style>
</head>
<body class="paid"><!-- show full experience by default; promos upsell -->

  <!-- Background video -->
  <div class="video-bg">
    <video id="bgvid" autoplay loop muted playsinline poster="https://via.placeholder.com/1920x1080?text=Loading+Video">
      <source src="videos/background.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Overlay PNGs -->
  <div class="overlay-layer" id="overlay">
    <picture id="overlay-paid">
      <source media="(max-width: 1200px)" srcset="images/Copyblockmobile_paid.png">
      <img src="images/Copyblockdesktop_paid.png" alt="SF Speed Cameras">
    </picture>
  </div>

  <!-- Page -->
  <div class="page">
    <div class="content-wrap">
      <!-- Controls + Map + List -->
      <div id="premium-content">
        <div class="d-flex gap-2 mb-3">
          <button id="soundGps" class="btn btn-off btn-sm" type="button" title="Cycle: Off → GPS only → Sound+GPS">Sound &amp; GPS: Off</button>
          <button id="followMe" class="btn btn-outline-light btn-sm" type="button" title="Keep map centered on you">Follow Me: On</button>
          <a class="btn btn-primary btn-sm ms-auto" href="https://buy.stripe.com/eVq4gA1ra1ptdAT1ZQfbq01" target="_top" rel="noopener">Go Pro – $12</a>
        </div>
        <div id="map" class="mb-3" tabindex="-1"></div>
        <div id="list" class="card mb-3">
          <div class="card-header">Camera Locations</div>
          <ul class="list-group camera-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- SPEED LIMIT sign -->
  <div id="speedSign" class="speed-sign" aria-live="polite" hidden>
    <div class="sign">
      <div class="label">SPEED LIMIT</div>
      <div class="value" id="speedLimitValue">--</div>
      <div class="capsule">SPEED CAMERA ZONE</div>
    </div>
  </div>

  <!-- Promo Modal -->
  <div id="promo" class="promo-overlay" aria-modal="true" role="dialog" aria-label="Promotion">
    <div class="promo-card">
      <div class="promo-badge" id="promoBadge">Try it free</div>
      <button class="promo-close" id="promoClose" aria-label="Close">✕</button>
      <img id="promoImg" src="images/Ad1.png" alt="Upgrade for full alerts">
      <div class="promo-controls">
        <button id="promoSnooze" class="promo-btn promo-ghost">Maybe later</button>
        <button id="promoGo" class="promo-btn promo-primary">Go Pro – $12</button>
      </div>
    </div>
  </div>

  <footer>
    <small>&copy; 2025 SF Speed Cameras • <a href="#" class="text-white-50">Privacy</a> • <a href="#" class="text-white-50">Contact</a></small>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* -------------------- General boot hygiene -------------------- */
try { history.scrollRestoration = 'manual'; } catch {}
if (location.hash) { history.replaceState(null, '', location.pathname); }
window.addEventListener('load', () => { window.scrollTo(0, 0); document.activeElement?.blur?.(); });

/* Background video height fix */
const bg = document.getElementById('bgvid');
bg?.addEventListener('ended', ()=>{ try{ bg.currentTime = 0; bg.play(); }catch(e){} }, false);
function sizeBG(){ const el=document.querySelector('.video-bg'); if(!el) return; el.style.height = window.innerHeight + 'px'; }
window.addEventListener('resize', sizeBG); window.addEventListener('orientationchange', sizeBG); sizeBG();

/* -------------------- Stripe target -------------------- */
const STRIPE_URL = "https://buy.stripe.com/eVq4gA1ra1ptdAT1ZQfbq01";

/* -------------------- Map + list + camera radii -------------------- */
const ENTER_M = 25, EXIT_M = 45; // used for radius visuals too

const cameras = [
  {name:"Fulton Street from 42nd to 43rd Ave",lat:37.7725,lon:-122.5015},
  {name:"Lincoln Way from 27th to 28th Ave",lat:37.7658,lon:-122.4860},
  {name:"Geary Blvd from 7th to 8th Ave",lat:37.7805,lon:-122.4660},
  {name:"Fulton St from 2nd Ave to Arguello Blvd",lat:37.7735,lon:-122.4550},
  {name:"Geary Blvd from Webster to Buchanan St",lat:37.7845,lon:-122.4310},
  {name:"Turk St from Van Ness Ave to Polk St",lat:37.7820,lon:-122.4195},
  {name:"Bay St from Octavia to Gough St",lat:37.8040,lon:-122.4230},
  {name:"Franklin St from Union to Green St",lat:37.8000,lon:-122.4235},
  {name:"Columbus Ave from Lombard to Greenwich St",lat:37.8025,lon:-122.4135},
  {name:"Broadway from Powell to Stockton St",lat:37.7975,lon:-122.4075},
  {name:"The Embarcadero from Green to Battery St",lat:37.8070,lon:-122.4005},
  {name:"Mission St from 8th to 9th St",lat:37.7740,lon:-122.4110},
  {name:"10th St from Harrison to Folsom St",lat:37.7715,lon:-122.4115},
  {name:"9th St from Bryant to Harrison St",lat:37.7725,lon:-122.4090},
  {name:"7th St from Harrison to Folsom St",lat:37.7745,lon:-122.4065},
  {name:"Harrison St from 4th to 5th St",lat:37.7795,lon:-122.4015},
  {name:"Bryant St from 2nd to 3rd St",lat:37.7820,lon:-122.3965},
  {name:"King St (EB only) from 4th to 5th St",lat:37.7775,lon:-122.3940},
  {name:"Market St from Danvers to Douglass St",lat:37.7615,lon:-122.4320},
  {name:"Guerrero St from 19th to 20th St",lat:37.7590,lon:-122.4230},
  {name:"16th St from Bryant St to Potrero Ave",lat:37.7650,lon:-122.4075},
  {name:"San Jose Ave from 29th to 30th St",lat:37.7435,lon:-122.4235},
  {name:"Cesar Chavez St from Folsom to Harrison St",lat:37.7480,lon:-122.4035},
  {name:"Cesar Chavez St from Indiana to Tennessee St",lat:37.7505,lon:-122.3900},
  {name:"3rd St (NB only) from Key to Jamestown Ave",lat:37.7275,lon:-122.3885},
  {name:"Bayshore Blvd (SB only) from 101 off-ramp to Tunnel Ave",lat:37.7100,lon:-122.3990},
  {name:"Geneva Ave from Prague St to Brookdale Ave",lat:37.7130,lon:-122.4405},
  {name:"Mission St from Ottawa Ave to Allison St",lat:37.7145,lon:-122.4400},
  {name:"Alemany Blvd from Farragut to Naglee Ave",lat:37.7320,lon:-122.4425},
  {name:"Ocean Ave from Frida Kahlo Way to Howth St",lat:37.7235,lon:-122.4525},
  {name:"San Jose Ave from Santa Ynez to Ocean Ave",lat:37.7280,lon:-122.4430},
  {name:"Monterey Blvd from Edna to Congo St",lat:37.7315,lon:-122.4650},
  {name:"Sloat Blvd from 41st Ave to Skyline Blvd",lat:37.7355,lon:-122.4980}
];

let map, userMarker, userAccuracy, follow = true;
const cameraLayers = [];

function initMap(){
  map = L.map('map', { zoomControl:true }).setView([37.7749,-122.4194],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

  // Markers + radius
  cameras.forEach(c => {
    const m = L.marker([c.lat,c.lon]).addTo(map).bindPopup(c.name);
    const circle = L.circle([c.lat, c.lon], {
      radius: ENTER_M, color:'#e74c3c', weight:2, fill:true, fillOpacity:0.15
    }).addTo(map);
    cameraLayers.push({marker:m, circle, name:c.name});
  });

  // List clicks fly to cam + play location tag
  const ul = document.querySelector('.camera-list');
  if (ul){
    cameras.forEach(c=>{
      const li=document.createElement('li');
      li.className='list-group-item';
      li.textContent=c.name;
      li.addEventListener('click',()=>{
        map.setView([c.lat,c.lon],15);
        playLocationOnly(c.name);
      });
      ul.appendChild(li);
    });
  }

  document.getElementById('map').setAttribute('tabindex','-1');
}

/* -------------------- Audio: stems, tags, locations -------------------- */
const AUDIO_BASE = 'images/audio/';
const STEMS = Array.from({length:11},(_,i)=>`speed_camera_ahead_${i+1}.mp3`);
const TAGS = [
  'brake_the_habit.mp3','this_pic_is_not_for_the_gram.mp3','your_wallet_just_got_a_little_nervous.mp3',
  'no_need_for_a_photo_finish.mp3','your_best_pose_is_slow.mp3','they_go_high_we_go_slow.mp3',
  'keep_it_chill_avoid_the_bill.mp3','slow_is_the_new_fast.mp3','pace_yourself.mp3',
  'less_gas_more_class.mp3','the_smart_money_is_on_slowing_down.mp3','avoid_the_money_shot.mp3',
  'chill_now_thank_yourself_later.mp3','no_rush_no_fuss.mp3','safety_first_bitches.mp3',
  'easy_does_it.mp3','save_the_drama_for_the_drivethru.mp3','your_brakes_called_they_are_ready_to_help.mp3',
  'lets_keep_your_record_clean_ish.mp3','slow_jams_only.mp3','brake_it_till_you_make_it.mp3',
  'slow_and_easy_hotshot.mp3','the_only_rush_is_in_your_head.mp3','drive_like_someone_is_watching.mp3',
  'give_those_brakes_a_little_love.mp3','slow_is_the_flex.mp3','your_future_self_says_thanks.mp3',
  'brakes_are_a_good_good_friend.mp3'
];
const LOC = {
  "Fulton Street from 42nd to 43rd Ave":"fulton_street_from_42nd_to_43rd_ave.mp3",
  "Lincoln Way from 27th to 28th Ave":"lincoln_way_from_27th_to_28th_ave.mp3",
  "Geary Blvd from 7th to 8th Ave":"geary_blvd_from_7th_to_8th_ave.mp3",
  "Fulton St from 2nd Ave to Arguello Blvd":"fulton_st_from_2nd_ave_to_arguello_blvd.mp3",
  "Geary Blvd from Webster to Buchanan St":"geary_blvd_from_webster_to_buchanan_st.mp3",
  "Turk St from Van Ness Ave to Polk St":"turk_st_from_van_ness_ave_to_polk_st.mp3",
  "Bay St from Octavia to Gough St":"bay_st_from_octavia_to_gough_st.mp3",
  "Franklin St from Union to Green St":"franklin_st_from_union_to_green_st.mp3",
  "Columbus Ave from Lombard to Greenwich St":"columbus_ave_from_lombard_to_greenwich_st.mp3",
  "Broadway from Powell to Stockton St":"broadway_from_powell_to_stockton_st.mp3",
  "The Embarcadero from Green to Battery St":"the_embarcadero_from_green_to_battery_st.mp3",
  "Mission St from 8th to 9th St":"mission_st_from_8th_to_9th_st.mp3",
  "10th St from Harrison to Folsom St":"10th_st_from_harrison_to_folsom_st.mp3",
  "9th St from Bryant to Harrison St":"9th_st_from_bryant_to_harrison_st.mp3",
  "7th St from Harrison to Folsom St":"7th_st_from_harrison_to_folsom_st.mp3",
  "Harrison St from 4th to 5th St":"harrison_st_from_4th_to_5th_st.mp3",
  "Bryant St from 2nd to 3rd St":"bryant_st_from_2nd_to_3rd_st.mp3",
  "King St (EB only) from 4th to 5th St":"king_st_eb_only_from_4th_to_5th_st.mp3",
  "Market St from Danvers to Douglass St":"market_st_from_danvers_to_douglass_st.mp3",
  "Guerrero St from 19th to 20th St":"guerrero_st_from_19th_to_20th_st.mp3",
  "16th St from Bryant St to Potrero Ave":"16th_st_from_bryant_st_to_potrero_ave.mp3",
  "San Jose Ave from 29th to 30th St":"san_jose_ave_from_29th_to_30th_st.mp3",
  "Cesar Chavez St from Folsom to Harrison St":"cesar_chavez_st_from_folsom_to_harrison_st.mp3",
  "Cesar Chavez St from Indiana to Tennessee St":"cesar_chavez_st_from_indiana_to_tennessee_st.mp3",
  "3rd St (NB only) from Key to Jamestown Ave":"3rd_st_nb_only_from_key_to_jamestown_ave.mp3",
  "Bayshore Blvd (SB only) from 101 off-ramp to Tunnel Ave":"bayshore_blvd_sb_only_from_101_off_ramp_to_tunnel_ave.mp3",
  "Geneva Ave from Prague St to Brookdale Ave":"geneva_ave_from_prague_st_to_brookdale_ave.mp3",
  "Mission St from Ottawa Ave to Allison St":"mission_st_from_ottawa_ave_to_allison_st.mp3",
  "Alemany Blvd from Farragut to Naglee Ave":"alemany_blvd_from_farragut_to_naglee_ave.mp3",
  "Ocean Ave from Frida Kahlo Way to Howth St":"ocean_ave_from_frida_kahlo_way_to_howth_st.mp3",
  "San Jose Ave from Santa Ynez to Ocean Ave":"san_jose_ave_from_santa_ynez_to_ocean_ave.mp3",
  "Monterey Blvd from Edna to Congo St":"monterey_blvd_from_edna_to_congo_st.mp3",
  "Sloat Blvd from 41st Ave to Skyline Blvd":"sloat_blvd_from_41st_ave_to_skyline_blvd.mp3"
};

function pick(a){ return a[Math.floor(Math.random()*a.length)] }
function playFile(f){ new Audio(AUDIO_BASE+f).play().catch(()=>{}); }
function playLocationOnly(name){ const f=LOC[name]; if(f) playFile(f); }

// guard against jitter double-plays
let __playing = false;
function playChain(files){
  if(!files.length || __playing) return;
  __playing = true;
  const a = new Audio(AUDIO_BASE+files[0]);
  a.play().catch(()=>{});
  a.onended = ()=>{
    if(files.length>1) playChain(files.slice(1));
    else setTimeout(()=>{ __playing=false; }, 250);
  };
}
function playGeofenceAlert(name){
  const f = LOC[name];
  if(!f) return;
  playChain([pick(STEMS), f, pick(TAGS)]);
  if(navigator.vibrate) navigator.vibrate([250,100,250]);
}

/* -------------------- Speed sign -------------------- */
const SPEED_LIMITS = {}; // from corridors
let currentZone = null;
function showSpeedSign(limit){
  const box = document.getElementById('speedSign'); const val = document.getElementById('speedLimitValue');
  if (!box || !val) return;
  if (Number.isFinite(limit)){ val.textContent = String(limit); box.classList.remove('unknown'); }
  else { val.textContent = '--'; box.classList.add('unknown'); }
  box.hidden = false; box.classList.add('show');
}
function hideSpeedSign(){ const box=document.getElementById('speedSign'); if(!box) return; box.classList.remove('show'); setTimeout(()=>{box.hidden=true;},250); }

/* -------------------- ArcGIS corridors + weekly refresh -------------------- */
const ARCGIS_LAYER_URL = 'https://services.arcgis.com/Zs2aNLFN00jrS4gG/arcgis/rest/services/Proposed_Automated_Speed_Enforcement_Locations_WFL1/FeatureServer/4';
const NAME_FIELDS  = ['CORRIDOR','Name','NAME','Segment','SEGMENT','Corridor'];
const SPEED_FIELDS = ['SPEEDLIMIT','SPEED_LIMIT','SpeedLimit','Speed_Limit','POSTED','POSTED_SPEED'];
const CACHE_KEY = 'sf_ase_corridors_v1';
const CACHE_TIME_KEY = 'sf_ase_corridors_v1_time';
const WEEK_MS = 7*24*60*60*1000;

let CORRIDOR_INDEX = new Map(); // name -> { line, buffer, speed, dir }
function getProp(o,keys){ for(const k of keys){ if(o && o[k]!=null && o[k]!=='') return o[k]; } return null; }

async function fetchLiveCorridors(){
  const url = `${ARCGIS_LAYER_URL}/query?where=1%3D1&outFields=*&outSR=4326&f=geojson`;
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error('ArcGIS down');
  return await r.json();
}
function loadCache(){ try{ const s=localStorage.getItem(CACHE_KEY); return s?JSON.parse(s):null; }catch{ return null; } }
function saveCache(fc){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(fc)); localStorage.setItem(CACHE_TIME_KEY, String(Date.now())); }catch{} }

async function ensureCorridors(){
  let fc = loadCache();
  const last = Number(localStorage.getItem(CACHE_TIME_KEY)||0);
  const stale = !last || (Date.now() - last > WEEK_MS); // weekly refresh

  if(!fc || stale){
    try{ fc = await fetchLiveCorridors(); saveCache(fc); }
    catch{ /* keep whatever we had */ }
  }else{
    // Soft-refresh in background
    fetchLiveCorridors().then(saveCache).catch(()=>{});
  }

  if(!fc) return;

  CORRIDOR_INDEX.clear();
  (fc.features||[]).forEach(feat=>{
    const props = feat.properties || {};
    let geom = feat.geometry;
    if(!geom) return;

    if(geom.type==='MultiLineString'){
      geom = { type:'LineString', coordinates: geom.coordinates.sort((a,b)=>b.length-a.length)[0] };
    }
    if(geom.type!=='LineString') return;

    const nameRaw = getProp(props, NAME_FIELDS);
    const name = nameRaw ? String(nameRaw).trim() : null;
    if(!name) return;

    const speed = Number(getProp(props, SPEED_FIELDS));
    const line  = geom;

    // narrow corridor membership polygon
    let buffered = null;
    try{ buffered = turf.buffer(line, 20, { units:'meters' }); }catch{}

    CORRIDOR_INDEX.set(name, {
      line,
      buffer: buffered,
      speed: Number.isFinite(speed)?speed:null,
      dir: props.Direction || props.DIRECTION || null
    });

    if(Number.isFinite(speed)) SPEED_LIMITS[name] = speed;
  });
}

/* -------------------- Geofencing w/ bearing filter -------------------- */
const MAX_ACC_M = 30, MIN_SPEED_MPS = 2.2, COOLDOWN_MS = 45000;
const insideNow = new Set(), lastAlertAt = new Map();

function toRad(d){return d*Math.PI/180}
function distKm(aLat,aLon,bLat,bLon){
  const R=6371,dLat=toRad(bLat-aLat),dLon=toRad(bLon-aLon);
  const s=Math.sin(dLat/2)**2+Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}
function passesGates(coords){
  const {accuracy,speed}=coords;
  if(accuracy && accuracy>MAX_ACC_M) return false;
  if(typeof speed==='number' && speed<MIN_SPEED_MPS) return false;
  return true;
}
function headingMatches(headingDeg, dir){
  if(!dir || typeof headingDeg!=='number') return true;
  const map={NB:0,N:0,EB:90,E:90,SB:180,S:180,WB:270,W:270};
  const tgt = map[String(dir).toUpperCase()] ?? null; if(tgt==null) return true;
  const diff = Math.min(Math.abs(headingDeg-tgt), 360-Math.abs(headingDeg-tgt));
  return diff <= 60;
}
function inCorridorBuffer(name, lngLat){
  const e = CORRIDOR_INDEX.get(name);
  if (!e || !e.buffer) return false;
  return turf.booleanPointInPolygon(turf.point(lngLat), e.buffer);
}
async function corridorDistanceM(name, lngLat){
  const e = CORRIDOR_INDEX.get(name);
  if(e && e.line) return turf.pointToLineDistance(turf.point(lngLat), e.line, { units:'meters' });
  const cam = cameras.find(c=>c.name===name); if(!cam) return Infinity;
  return distKm(lngLat[1],lngLat[0],cam.lat,cam.lon)*1000;
}
function headingAlignsWithLine(name, lngLat, userHeading){
  const e = CORRIDOR_INDEX.get(name);
  if (!e || !e.line || typeof userHeading !== 'number') return true;
  const pt = turf.point(lngLat);
  const snapped = turf.nearestPointOnLine(e.line, pt);
  const idx = snapped.properties.index;
  const coords = e.line.coordinates;
  const a = coords[Math.max(0, idx - 1)];
  const b = coords[Math.min(coords.length - 1, idx + 1)];
  if (!a || !b) return true;
  const segBearing = turf.bearing(turf.point(a), turf.point(b));
  const user = ((userHeading % 360) + 360) % 360;
  const seg  = ((segBearing  % 360) + 360) % 360;
  const diff = Math.min(Math.abs(user - seg), 360 - Math.abs(user - seg));
  return diff <= 60;
}

/* -------------------- Sound/GPS tri-state + live location -------------------- */
const soundBtn = document.getElementById('soundGps');
const followBtn = document.getElementById('followMe');
let gpsState = 'off'; // 'off' | 'gps' | 'on'
let follow = true;

function reflectButtons(){
  followBtn.classList.toggle('btn-on', follow);
  followBtn.textContent = `Follow Me: ${follow ? 'On' : 'Off'}`;

  if(gpsState==='off'){
    soundBtn.className='btn btn-off btn-sm';
    soundBtn.textContent='Sound & GPS: Off';
    soundBtn.setAttribute('aria-pressed','false');
  } else if (gpsState==='gps'){
    soundBtn.className='btn btn-gps btn-sm';
    soundBtn.textContent='GPS On • Sound Off';
    soundBtn.setAttribute('aria-pressed','mixed');
  } else {
    soundBtn.className='btn btn-on btn-sm';
    soundBtn.textContent='Sound & GPS: On';
    soundBtn.setAttribute('aria-pressed','true');
  }
}

followBtn?.addEventListener('click', ()=>{ follow=!follow; reflectButtons(); });

soundBtn?.addEventListener('click', ()=>{
  gpsState = (gpsState==='off') ? 'gps' : (gpsState==='gps' ? 'on' : 'off');
  if(gpsState==='off'){
    if (navigator.geolocation && window.__watchId!=null){ navigator.geolocation.clearWatch(window.__watchId); window.__watchId=null; }
  } else {
    startGPS(); // (re)start watch
  }
  reflectButtons();
});
reflectButtons();

/* Live user marker + accuracy + follow */
function updateUserOnMap(lat, lon, acc){
  const latlng = [lat, lon];
  if(!userMarker){
    userMarker = L.circleMarker(latlng, {radius:6, color:'#007bff', fillColor:'#007bff', fillOpacity:1}).addTo(map);
  } else userMarker.setLatLng(latlng);

  if(!userAccuracy){
    userAccuracy = L.circle(latlng, {radius:acc||10, color:'#007bff', weight:1, fill:true, fillOpacity:0.08}).addTo(map);
  } else {
    userAccuracy.setLatLng(latlng);
    userAccuracy.setRadius(acc||10);
  }
  if (follow) map.setView(latlng, Math.max(map.getZoom(), 14), {animate:false});
}

/* -------------------- Geofencing loop (watchPosition) -------------------- */
function startGPS(){
  if(!('geolocation' in navigator)) return;
  if(window.__watchId!=null) return;

  // kick audio subsystem once for iOS (no-op if blocked)
  try{ new Audio().play().catch(()=>{}); }catch(e){}

  window.__watchId = navigator.geolocation.watchPosition(async pos=>{
    const {latitude,longitude,accuracy,speed,heading}=pos.coords;
    updateUserOnMap(latitude, longitude, accuracy);

    if(!passesGates(pos.coords)) return;
    const now=Date.now(), lngLat=[longitude,latitude];

    for(const cam of cameras){
      const ent = CORRIDOR_INDEX.get(cam.name);
      if(!ent) continue;

      // Directional tag + local bearing
      if (ent.dir && !headingMatches(heading, ent.dir)) continue;
      if (!headingAlignsWithLine(cam.name, lngLat, heading)) continue;

      // membership / distance with hysteresis
      const inside = inCorridorBuffer(cam.name, lngLat);
      const dM = inside ? 0 : await corridorDistanceM(cam.name, lngLat);
      const wasIn = insideNow.has(cam.name);
      const entering = (!wasIn) && (inside || dM <= ENTER_M);
      const exiting  = wasIn && (!inside && dM > EXIT_M);

      if (entering) {
        const last = lastAlertAt.get(cam.name)||0;
        if (now-last > COOLDOWN_MS) {
          if (gpsState!=='off'){          // GPS must be active
            if (gpsState==='on'){         // sound only in 'on'
              playGeofenceAlert(cam.name);
            }
            const limit = (ent && ent.speed) || SPEED_LIMITS[cam.name];
            showSpeedSign(limit);
            lastAlertAt.set(cam.name, now);
          }
        }
        insideNow.add(cam.name);
        currentZone = cam.name;
      } else if (exiting) {
        insideNow.delete(cam.name);
        if (currentZone === cam.name){ currentZone = null; hideSpeedSign(); }
      }
    }
  }, err=>console.warn('Geolocation error', err),
  { enableHighAccuracy:true, maximumAge:500, timeout:8000 });
}

/* -------------------- Promos every 30 minutes (audio overrides mute) -------------------- */
const PROMOS = [
  { img:'images/Ad1.png', audio:'images/audio/Ad1.mp3', seconds:7, badge:'New in SF' },
  { img:'images/Ad2.png', audio:'images/audio/Ad1.mp3', seconds:6, badge:'Try it free' }
];
const PROMO_INTERVAL_MS = 30 * 60 * 1000;
const PROMO_LAST_KEY = 'promo_last_time_v1';

const promoEl   = document.getElementById('promo');
const promoImg  = document.getElementById('promoImg');
const promoClose= document.getElementById('promoClose');
const promoGo   = document.getElementById('promoGo');
const promoSnooze = document.getElementById('promoSnooze');
const promoBadge  = document.getElementById('promoBadge');

let promoIdx = 0, promoAudio = null, promoTimer = null;

function openPromo(i){
  const p = PROMOS[i]; if(!p) return closePromo();
  promoImg.src = p.img;
  promoBadge.textContent = p.badge || 'Upgrade';
  promoEl.classList.add('show');

  // ALWAYS play voiceover, regardless of app mute state (may still be blocked by OS autoplay rules)
  try{
    promoAudio = new Audio(p.audio);
    promoAudio.play().catch(()=>{ /* mobile might block until first gesture */});
  }catch(e){}

  clearTimeout(promoTimer);
  promoTimer = setTimeout(nextPromo, p.seconds*1000);
}
function stopPromoAudio(){ try{ promoAudio?.pause?.(); }catch{} promoAudio=null; }
function closePromo(){ promoEl.classList.remove('show'); clearTimeout(promoTimer); stopPromoAudio(); }
function nextPromo(){ closePromo(); promoIdx++; if (promoIdx < PROMOS.length) openPromo(promoIdx); else markPromoShownNow(); }
function markPromoShownNow(){ localStorage.setItem(PROMO_LAST_KEY, String(Date.now())); }

promoClose?.addEventListener('click', nextPromo);
promoGo?.addEventListener('click', ()=>{ window.location.href = STRIPE_URL; });
promoSnooze?.addEventListener('click', ()=>{ markPromoShownNow(); closePromo(); });

function maybeShowPromos(){
  const last = Number(localStorage.getItem(PROMO_LAST_KEY)||0);
  if (!last || (Date.now()-last) >= PROMO_INTERVAL_MS){
    promoIdx = 0;
    openPromo(0);
  }
}

/* -------------------- Boot -------------------- */
(async function boot(){
  initMap();
  await ensureCorridors();
  reflectButtons();
  // Start in GPS-only mute state for initial map follow (optional)
  // gpsState='gps'; startGPS(); reflectButtons();

  // Kick first promo a few seconds after load if due
  setTimeout(maybeShowPromos, 3500);
})();
</script>
</body>
</html>
