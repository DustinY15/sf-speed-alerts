<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>SF Speed Cameras – Pro</title>

<!-- ONE-TIME RECOVERY: kill old SW + caches, then hard reload once -->
<script>
(function(){
  const BUSTER='recover-2025-08-09-1';
  if(localStorage.getItem('cache_buster')===BUSTER) return;
  localStorage.setItem('cache_buster',BUSTER);
  if('serviceWorker' in navigator){
    navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister()));
  }
  if(window.caches && caches.keys){
    caches.keys().then(keys=>Promise.all(keys.map(k=>caches.delete(k))));
  }
  setTimeout(()=>location.replace(location.pathname+'?forcePaid'),300);
})();
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
  :root{
    --overlay-top: 10px;
    --paid-offset-mobile: 260px;
    --paid-offset-desktop: 330px;

    /* button colors */
    --state-off:#dc3545;  /* red */
    --state-gps:#ffc107;  /* yellow */
    --state-on:#28a745;   /* green */
  }

  html, body { height:100%; }
  body{
    margin:0; background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Arial; font-weight:600;
    display:flex; flex-direction:column; overflow-x:hidden;
  }
  .page { flex:1 0 auto; position:relative; }
  footer { flex:0 0 auto; padding:14px 0 18px; text-align:center; }

  /* background video centered forever */
  .video-bg{ position:fixed; left:0; top:0; width:100vw; height:100dvh; z-index:-3; overflow:hidden; }
  .video-bg video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center center; }

  /* overlay PNGs */
  .overlay-layer{ position:absolute; left:0; top:var(--overlay-top); width:100%; z-index:2; pointer-events:none; }
  .overlay-layer img{ width:100%; height:auto; display:block; }

  /* content is pushed under the PNGs */
  .content-wrap{ position:relative; padding:16px 20px 24px; z-index:1; margin-top:var(--paid-offset-mobile); }
  @media (min-width:1200px){
    .content-wrap{ margin-top:var(--paid-offset-desktop); }
  }

  /* map + list */
  #map{ height:60vh; border:1px solid #ddd; border-radius:8px; background:rgba(255,255,255,.85); }
  @media (max-width:1200px){ #map{ height:50vh; } }
  .camera-list{ max-height:220px; overflow-y:auto; }

  /* 3-state button */
  #modeBtn{
    border:0; font-weight:800; color:#000; padding:.4rem .75rem; border-radius:.5rem;
  }
  #modeBtn.state-off{ background:var(--state-off); color:#fff; }
  #modeBtn.state-gps{ background:var(--state-gps); color:#111; }
  #modeBtn.state-on { background:var(--state-on);  color:#fff; }

  /* speed sign */
  .speed-sign { position:fixed; left:50%; top:12px; transform:translateX(-50%) translateY(-20px); z-index:50; pointer-events:none; opacity:0; transition:opacity .2s, transform .25s; }
  .speed-sign.show { opacity:1; transform:translateX(-50%) translateY(0); }
  .speed-sign .sign{ background:#fff; color:#000; border:4px solid #000; border-radius:10px; width:min(46vw, 280px); padding:10px 14px 12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .speed-sign .label{ font-weight:800; letter-spacing:.06em; text-align:center; font-size:14px; margin-bottom:4px; }
  .speed-sign .value{ font-weight:900; text-align:center; font-size:clamp(56px, 16vw, 110px); line-height:1; }
  .speed-sign .capsule{ margin-top:8px; text-align:center; font-size:12px; font-weight:700; letter-spacing:.04em; color:#111; background:#eee; border-radius:999px; padding:4px 10px; display:none; }
  .speed-sign.unknown .capsule{ display:inline-block; }

  /* nag popup */
  .nag-wrap{
    position:fixed; left:0; right:0; top:25px; /* lowered 25px per ask */
    display:flex; justify-content:center; z-index:1000; pointer-events:none;
  }
  .nag{
    pointer-events:auto; background:transparent; border:none; padding:0; margin:0;
  }
  .nag img{
    width:min(92vw, 560px); /* +20% bigger look */
    max-width:100%;
    height:auto; display:block;
    box-shadow:0 20px 60px rgba(0,0,0,.55);
  }
  .nag .close-x{
    position:absolute; top:6px; right:10px; background:rgba(0,0,0,.5); color:#fff; border:none;
    width:32px; height:32px; border-radius:999px; font-weight:900; display:flex; align-items:center; justify-content:center;
    cursor:pointer;
  }

  /* follow marker styles (user) */
  .loc-accuracy{
    stroke:#1f6feb; stroke-opacity:.6; fill:#1f6feb; fill-opacity:.12;
  }
  .loc-dot{
    background:#1f6feb; width:14px; height:14px; border-radius:50%; border:2px solid #fff;
    box-shadow:0 0 0 3px rgba(31,111,235,.35);
  }
  .leaflet-user-dot{
    width:18px; height:18px; display:inline-block;
  }
</style>
</head>
<body>

  <!-- background video -->
  <div class="video-bg">
    <video id="bgvid" autoplay loop muted playsinline poster="https://via.placeholder.com/1920x1080?text=Loading+Video">
      <source src="videos/background.mp4?v=2025-08-09-1" type="video/mp4">
    </video>
  </div>

  <!-- overlay art (PAID) -->
  <div class="overlay-layer">
    <picture id="overlay-paid">
      <source media="(max-width: 1200px)" srcset="images/Copyblockmobile_paid.png?v=2025-08-09-1">
      <img src="images/Copyblockdesktop_paid.png?v=2025-08-09-1" alt="SF Speed Cameras (Pro)">
    </picture>
  </div>

  <!-- page -->
  <div class="page">
    <div class="content-wrap">
      <!-- top row: 3-state button + Go Pro (Stripe) -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <button id="modeBtn" class="state-off" aria-pressed="false" aria-label="Sound and GPS mode">Sound &amp; GPS: Off</button>
        <a class="btn btn-primary btn-sm" href="https://buy.stripe.com/eVq4gA1ra1ptdAT1ZQfbq01">Go Pro</a>
      </div>

      <!-- map -->
      <div id="map" class="mb-3" tabindex="-1" aria-label="Map of camera corridors"></div>

      <!-- list -->
      <div id="list" class="card mb-3">
        <div class="card-header">Camera Locations</div>
        <ul class="list-group camera-list"></ul>
      </div>
    </div>
  </div>

  <!-- SPEED LIMIT sign -->
  <div id="speedSign" class="speed-sign" aria-live="polite" hidden>
    <div class="sign">
      <div class="label">SPEED LIMIT</div>
      <div class="value" id="speedLimitValue">--</div>
      <div class="capsule">SPEED CAMERA ZONE</div>
    </div>
  </div>

  <!-- nag popup (hidden initially) -->
  <div id="nagWrap" class="nag-wrap" style="display:none;">
    <div class="nag position-relative">
      <button id="nagClose" class="close-x" aria-label="Close popup" disabled>×</button>
      <a id="nagLink" href="https://buy.stripe.com/eVq4gA1ra1ptdAT1ZQfbq01">
        <img id="nagImg" src="images/Ad1.png?v=2025-08-09-1" alt="Upgrade prompt">
      </a>
      <audio id="nagAudio" preload="auto">
        <source src="images/audio/Ad1.mp3?v=2025-08-09-1" type="audio/mpeg">
      </audio>
    </div>
  </div>

  <footer>
    <small>&copy; 2025 SF Speed Cameras • <a href="#" class="text-white-50">Privacy</a> • <a href="#" class="text-white-50">Contact</a></small>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* -------------------------------------------------
   HARD SETTINGS
--------------------------------------------------*/
const ARCGIS_CORRIDORS =
  'https://services.arcgis.com/Zs2aNLFN00jrS4gG/arcgis/rest/services/Proposed_Automated_Speed_Enforcement_Locations_WFL1/FeatureServer/4';

const AUDIO_BASE = 'images/audio/'; // your repo path
const STRIPE_URL = 'https://buy.stripe.com/eVq4gA1ra1ptdAT1ZQfbq01';

/* -------------------------------------------------
   BOOT: always paid, no SW, kill jumps
--------------------------------------------------*/
try { history.scrollRestoration = 'manual'; } catch {}
if (location.hash) { history.replaceState(null, '', location.pathname); }
window.addEventListener('load', () => { window.scrollTo(0,0); });

const q = new URLSearchParams(location.search);
if (q.has('forcePaid')) localStorage.setItem('paid','true');

/* -------------------------------------------------
   AUDIO: single global player, no overlaps
--------------------------------------------------*/
let audioUnlocked = false;
function unlockAudio(){
  if (audioUnlocked) return;
  audioUnlocked = true;
  try {
    const a = new Audio(); a.muted = true; a.play().catch(()=>{});
  } catch(_){}
}
['touchstart','click'].forEach(ev => document.addEventListener(ev, unlockAudio, {passive:true, once:false}));

const player = new Audio(); // single player for all short clips
player.preload = 'auto';
let chainQueue = [];
player.addEventListener('ended', ()=>{
  if (chainQueue.length) {
    const next = chainQueue.shift();
    player.src = next;
    player.play().catch(()=>{});
  }
});

function playNow(fileUrl){
  try{
    player.pause();
    player.currentTime = 0;
    chainQueue.length = 0;
    player.src = fileUrl;
    player.play().catch(()=>{});
  }catch(_){}
}
function playChain(files){
  try{
    player.pause();
    player.currentTime = 0;
    chainQueue = files.slice(1).map(f=>AUDIO_BASE+f);
    player.src = AUDIO_BASE + files[0];
    player.play().catch(()=>{});
  }catch(_){}
}

/* fun lines and location mapping (unchanged list) */
const STEMS = Array.from({length:11},(_,i)=>`speed_camera_ahead_${i+1}.mp3`);
const TAGS = [
  'brake_the_habit.mp3','this_pic_is_not_for_the_gram.mp3','your_wallet_just_got_a_little_nervous.mp3',
  'no_need_for_a_photo_finish.mp3','your_best_pose_is_slow.mp3','they_go_high_we_go_slow.mp3',
  'keep_it_chill_avoid_the_bill.mp3','slow_is_the_new_fast.mp3','pace_yourself.mp3',
  'less_gas_more_class.mp3','the_smart_money_is_on_slowing_down.mp3','avoid_the_money_shot.mp3',
  'chill_now_thank_yourself_later.mp3','no_rush_no_fuss.mp3','safety_first_bitches.mp3',
  'easy_does_it.mp3','save_the_drama_for_the_drivethru.mp3','your_brakes_called_they_are_ready_to_help.mp3',
  'lets_keep_your_record_clean_ish.mp3','slow_jams_only.mp3','brake_it_till_you_make_it.mp3',
  'slow_and_easy_hotshot.mp3','the_only_rush_is_in_your_head.mp3','drive_like_someone_is_watching.mp3',
  'give_those_brakes_a_little_love.mp3','slow_is_the_flex.mp3','your_future_self_says_thanks.mp3',
  'brakes_are_a_good_good_friend.mp3'
];
function pick(a){ return a[Math.floor(Math.random()*a.length)] }

/* your 33 points (kept for list clicks & map centering) */
const cameras = [
  {name:"Fulton Street from 42nd to 43rd Ave",lat:37.7725,lon:-122.5015},
  {name:"Lincoln Way from 27th to 28th Ave",lat:37.7658,lon:-122.4860},
  {name:"Geary Blvd from 7th to 8th Ave",lat:37.7805,lon:-122.4660},
  {name:"Fulton St from 2nd Ave to Arguello Blvd",lat:37.7735,lon:-122.4550},
  {name:"Geary Blvd from Webster to Buchanan St",lat:37.7845,lon:-122.4310},
  {name:"Turk St from Van Ness Ave to Polk St",lat:37.7820,lon:-122.4195},
  {name:"Bay St from Octavia to Gough St",lat:37.8040,lon:-122.4230},
  {name:"Franklin St from Union to Green St",lat:37.8000,lon:-122.4235},
  {name:"Columbus Ave from Lombard to Greenwich St",lat:37.8025,lon:-122.4135},
  {name:"Broadway from Powell to Stockton St",lat:37.7975,lon:-122.4075},
  {name:"The Embarcadero from Green to Battery St",lat:37.8070,lon:-122.4005},
  {name:"Mission St from 8th to 9th St",lat:37.7740,lon:-122.4110},
  {name:"10th St from Harrison to Folsom St",lat:37.7715,lon:-122.4115},
  {name:"9th St from Bryant to Harrison St",lat:37.7725,lon:-122.4090},
  {name:"7th St from Harrison to Folsom St",lat:37.7745,lon:-122.4065},
  {name:"Harrison St from 4th to 5th St",lat:37.7795,lon:-122.4015},
  {name:"Bryant St from 2nd to 3rd St",lat:37.7820,lon:-122.3965},
  {name:"King St (EB only) from 4th to 5th St",lat:37.7775,lon:-122.3940},
  {name:"Market St from Danvers to Douglass St",lat:37.7615,lon:-122.4320},
  {name:"Guerrero St from 19th to 20th St",lat:37.7590,lon:-122.4230},
  {name:"16th St from Bryant St to Potrero Ave",lat:37.7650,lon:-122.4075},
  {name:"San Jose Ave from 29th to 30th St",lat:37.7435,lon:-122.4235},
  {name:"Cesar Chavez St from Folsom to Harrison St",lat:37.7480,lon:-122.4035},
  {name:"Cesar Chavez St from Indiana to Tennessee St",lat:37.7505,lon:-122.3900},
  {name:"3rd St (NB only) from Key to Jamestown Ave",lat:37.7275,lon:-122.3885},
  {name:"Bayshore Blvd (SB only) from 101 off-ramp to Tunnel Ave",lat:37.7100,lon:-122.3990},
  {name:"Geneva Ave from Prague St to Brookdale Ave",lat:37.7130,lon:-122.4405},
  {name:"Mission St from Ottawa Ave to Allison St",lat:37.7145,lon:-122.4400},
  {name:"Alemany Blvd from Farragut to Naglee Ave",lat:37.7320,lon:-122.4425},
  {name:"Ocean Ave from Frida Kahlo Way to Howth St",lat:37.7235,lon:-122.4525},
  {name:"San Jose Ave from Santa Ynez to Ocean Ave",lat:37.7280,lon:-122.4430},
  {name:"Monterey Blvd from Edna to Congo St",lat:37.7315,lon:-122.4650},
  {name:"Sloat Blvd from 41st Ave to Skyline Blvd",lat:37.7355,lon:-122.4980}
];

/* map */
let map, userDot, userCircle;
function makeUserMarker(){
  const div = L.divIcon({ className:'leaflet-user-dot', html:'<div class="loc-dot"></div>', iconSize:[18,18], iconAnchor:[9,9] });
  userDot = L.marker([37.7749,-122.4194], { icon: div });
  userCircle = L.circle([37.7749,-122.4194], {
    radius: 30, className:'loc-accuracy'
  });
  userDot.addTo(map);
  userCircle.addTo(map);
}

function initMap(){
  map = L.map('map', {zoomControl:true}).setView([37.7749,-122.4194], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

  // list (click plays location-only + centers map)
  const ul = document.querySelector('.camera-list');
  cameras.forEach(c=>{
    const li=document.createElement('li');
    li.className='list-group-item';
    li.textContent=c.name;
    li.addEventListener('click',()=>{
      map.setView([c.lat,c.lon],15);
      // location-only clip file name convention (you already uploaded these)
      // if any are missing, it will just no-op
      const fname = c.name
        .toLowerCase()
        .replace(/[()]/g,'')
        .replace(/[^a-z0-9]+/g,'_')
        .replace(/^_|_$/g,'') + '.mp3';
      playNow(AUDIO_BASE + fname);
    });
    ul.appendChild(li);
  });

  makeUserMarker();
}

/* fetch corridors (Layer 4) and draw only polylines */
const NAME_FIELDS  = ['CORRIDOR','Name','NAME','Segment','SEGMENT','Corridor'];
const SPEED_FIELDS = ['SPEEDLIMIT','SPEED_LIMIT','SpeedLimit','Speed_Limit','POSTED','POSTED_SPEED'];
const SPEED_LIMITS = {};
let CORRIDOR_INDEX = new Map();

function getProp(o,keys){ for(const k of keys){ if(o && o[k]!=null && o[k]!=='' ) return o[k]; } return null; }

async function fetchCorridors(){
  const url = `${ARCGIS_CORRIDORS}/query?where=1%3D1&outFields=*&outSR=4326&f=geojson`;
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('ArcGIS unreachable');
  return await r.json();
}
function drawCorridors(fc){
  (fc.features||[]).forEach(feat=>{
    if(!feat.geometry) return;
    let geom = feat.geometry;
    if(geom.type==='MultiLineString'){
      geom = {type:'LineString', coordinates: geom.coordinates.sort((a,b)=>b.length-a.length)[0]};
    }
    if(geom.type!=='LineString') return;

    const props = feat.properties||{};
    const name = (getProp(props, NAME_FIELDS)||'').toString().trim();
    const speed = Number(getProp(props, SPEED_FIELDS));
    if (Number.isFinite(speed)) SPEED_LIMITS[name]=speed;

    // leafet polyline from coords
    const latlngs = geom.coordinates.map(([lng,lat])=>[lat,lng]);
    const line = L.polyline(latlngs, {color:'#00d1ff', weight:5, opacity:.85}).addTo(map);

    // keep in index for geofencing
    CORRIDOR_INDEX.set(name, { lineGeo: geom, speed: Number.isFinite(speed)?speed:null, dir: props.Direction || props.DIRECTION || null });
  });
}

/* geofencing using corridors + heading */
const ENTER_M=25, EXIT_M=45, MAX_ACC_M=30, MIN_SPEED_MPS=2.2, COOLDOWN_MS=45000;
const insideNow = new Set(), lastAlertAt = new Map();
let currentZone = null;

function headingMatches(headingDeg, dir){
  if(!dir || typeof headingDeg!=='number') return true;
  const map={NB:0,N:0,EB:90,E:90,SB:180,S:180,WB:270,W:270};
  const tgt = map[String(dir).toUpperCase()] ?? null; if(tgt==null) return true;
  const diff = Math.min(Math.abs(headingDeg-tgt), 360-Math.abs(headingDeg-tgt));
  return diff <= 60;
}
function headingAlignsWithLine(name, lngLat, userHeading){
  const e = CORRIDOR_INDEX.get(name);
  if(!e || !e.lineGeo || typeof userHeading!=='number') return true;
  const pt = turf.point(lngLat);
  const snapped = turf.nearestPointOnLine(e.lineGeo, pt);
  const idx = snapped.properties.index;
  const coords = e.lineGeo.coordinates;
  const a = coords[Math.max(0, idx-1)];
  const b = coords[Math.min(coords.length-1, idx+1)];
  if(!a || !b) return true;
  const segBearing = turf.bearing(turf.point(a), turf.point(b));
  const user = ((userHeading%360)+360)%360;
  const seg = ((segBearing%360)+360)%360;
  const diff = Math.min(Math.abs(user-seg), 360-Math.abs(user-seg));
  return diff <= 60;
}
function showSpeedSign(limit){
  const box=document.getElementById('speedSign'), val=document.getElementById('speedLimitValue');
  if(!box||!val) return;
  if(Number.isFinite(limit)){ val.textContent=String(limit); box.classList.remove('unknown'); }
  else { val.textContent='--'; box.classList.add('unknown'); }
  box.hidden=false; box.classList.add('show');
}
function hideSpeedSign(){ const box=document.getElementById('speedSign'); if(!box) return; box.classList.remove('show'); setTimeout(()=>{box.hidden=true;},250); }

/* mode button (3 states): 0=off, 1=gps only, 2=sound+gps */
let mode = 0;
const modeBtn = document.getElementById('modeBtn');
function applyMode(){
  modeBtn.classList.remove('state-off','state-gps','state-on');
  if (mode===0){ modeBtn.classList.add('state-off'); modeBtn.textContent='Sound & GPS: Off'; modeBtn.setAttribute('aria-pressed','false'); stopGPS(); }
  else if (mode===1){ modeBtn.classList.add('state-gps'); modeBtn.textContent='GPS Only (Muted)'; modeBtn.setAttribute('aria-pressed','mixed'); startGPS(); }
  else { modeBtn.classList.add('state-on'); modeBtn.textContent='Sound & GPS: On'; modeBtn.setAttribute('aria-pressed','true'); startGPS(); }
}
modeBtn.addEventListener('click', ()=>{
  mode = (mode+1)%3;
  applyMode();
});
applyMode();

/* GPS follow + geofence */
let watchId = null;
function startGPS(){
  if (watchId!=null || !('geolocation' in navigator)) return;
  watchId = navigator.geolocation.watchPosition(async pos=>{
    const {latitude, longitude, accuracy, speed, heading} = pos.coords;
    if(accuracy && accuracy>MAX_ACC_M) return;

    // update user marker
    const latlng=[latitude, longitude];
    userDot.setLatLng(latlng);
    userCircle.setLatLng(latlng);
    userCircle.setRadius(Math.max(accuracy||20, 15));

    // keep map following user if fairly zoomed in
    const z = map.getZoom();
    if (z >= 14) map.panTo(latlng, {animate:true});

    // geofence on corridors
    if(typeof speed==='number' && speed<MIN_SPEED_MPS) return;

    const now = Date.now();
    const lngLat=[longitude, latitude];

    for (const [name,entry] of CORRIDOR_INDEX.entries()){
      if (entry.dir && !headingMatches(heading, entry.dir)) continue;
      if (!headingAlignsWithLine(name, lngLat, heading)) continue;

      const dM = turf.pointToLineDistance(turf.point(lngLat), entry.lineGeo, {units:'meters'});
      const wasIn = insideNow.has(name);
      const inNow = dM <= ENTER_M;

      if (!wasIn && inNow){
        const last = lastAlertAt.get(name) || 0;
        if (now-last > COOLDOWN_MS){
          if (mode===2){ // only speak if sound is on
            const stem = pick(STEMS);
            // location filename from list mapping (best-effort)
            const fname = name.toLowerCase().replace(/[()]/g,'').replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'')+'.mp3';
            // chain: stem -> location -> tag
            playChain([stem, fname, pick(TAGS)]);
            if(navigator.vibrate) navigator.vibrate([250,100,250]);
          }
          showSpeedSign(entry.speed ?? null);
          lastAlertAt.set(name, now);
        }
        insideNow.add(name);
        currentZone = name;
      } else if (wasIn && dM > EXIT_M){
        insideNow.delete(name);
        if (currentZone===name){ currentZone=null; hideSpeedSign(); }
      }
    }
  }, err=>console.warn('Geolocation error', err), { enableHighAccuracy:true, maximumAge:500, timeout:8000 });
}
function stopGPS(){
  if (watchId!=null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
}

/* NAG POPUP: 120s first, 30m thereafter; blocks close ~25s; plays even if muted */
const nagWrap = document.getElementById('nagWrap');
const nagImg  = document.getElementById('nagImg');
const nagAudio = document.getElementById('nagAudio');
const nagClose = document.getElementById('nagClose');
const nagLink  = document.getElementById('nagLink');

let nagIndex = 0; // 0 -> Ad1.png (provided), 1 -> Ad2.png (provided)
const NAGS = [
  'images/Ad1.png?v=2025-08-09-1',
  'images/Ad2.png?v=2025-08-09-1'
];

function showNag(){
  // swap graphic
  nagIndex = (nagIndex+1) % NAGS.length;
  nagImg.src = NAGS[nagIndex];

  // show UI
  nagWrap.style.display = 'flex';
  nagClose.disabled = true;

  // play audio even if muted state (override): we use a dedicated <audio> tag
  try {
    // restart from beginning and play
    nagAudio.currentTime = 0;
    const p = nagAudio.play();
    if (p && p.catch) p.catch(()=>{ /* autoplay might still be blocked if no tap yet */ });
  } catch(_){}

  // unlock close after ~25s (audio is ~24s)
  setTimeout(()=>{ nagClose.disabled = false; }, 25000);
  // autoclose at 25s too (so it doesn't linger if user does nothing)
  setTimeout(()=>{ closeNag(); }, 25050);
}
function closeNag(){
  nagWrap.style.display = 'none';
  try { nagAudio.pause(); } catch(_){}
}
nagClose.addEventListener('click', (e)=>{ e.preventDefault(); closeNag(); });

// schedule: first at 120s, then every 30 minutes
setTimeout(showNag, 120000);
setInterval(showNag, 30*60*1000);

// clicking the graphic goes to Stripe
nagLink.addEventListener('click', ()=>{ try{ nagAudio.pause(); }catch(_){} });

/* INIT */
(async function boot(){
  // always paid
  localStorage.setItem('paid','true');

  // video loop guard
  const bg = document.getElementById('bgvid');
  bg?.addEventListener('ended', ()=>{ try{ bg.currentTime=0; bg.play(); }catch(e){} }, false);
  function sizeBG(){ const el=document.querySelector('.video-bg'); if(!el) return; el.style.height = window.innerHeight + 'px'; }
  window.addEventListener('resize', sizeBG); window.addEventListener('orientationchange', sizeBG); sizeBG();

  // init map
  initMap();

  // fetch + draw corridors
  try{
    const fc = await fetchCorridors();
    drawCorridors(fc);
  }catch(e){
    console.warn('Corridors load failed', e);
  }
})();
</script>
</body>
</html>
