<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SF Speed Cameras – Alerts & Map</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
  :root{
    --overlay-top: 10px;
    --content-offset-m: 260px;
    --content-offset-d: 330px;
    --shell-max: 520px;
  }
  html, body { height:100%; }
  body{
    margin:0; background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Arial; font-weight:600;
    display:flex; flex-direction:column; overflow-x:hidden;
  }
  .page { flex:1 0 auto; position:relative; }
  footer { flex:0 0 auto; padding:14px 0 18px; text-align:center; }

  .video-bg{ position:fixed; left:0; top:0; width:100vw; height:100dvh; z-index:-3; overflow:hidden; }
  .video-bg video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center center; }

  .overlay-layer{ position:absolute; left:0; top:var(--overlay-top); width:100%; z-index:2; pointer-events:none; }
  .overlay-layer img{ width:100%; height:auto; display:block; }

  .app-shell{ width:min(92vw, var(--shell-max)); margin:0 auto; }
  .content-wrap{ position:relative; padding:16px 12px 24px; z-index:1; margin-top:var(--content-offset-m); }
  @media (min-width:1200px){ .content-wrap{ margin-top:var(--content-offset-d); } }

  .btn-row{ display:flex; gap:10px; align-items:center; }
  .btn-row .btn{ height:40px; line-height:40px; padding:0 14px; font-weight:700; }

  .state-off   { background:#c62828!important; border-color:#c62828!important; color:#fff!important; }
  .state-on    { background:#2e7d32!important; border-color:#2e7d32!important; color:#fff!important; }
  .state-mute  { background:#f9a825!important; border-color:#f9a825!important; color:#111!important; }

  #map{ height:60vh; border:1px solid #ddd; border-radius:8px; background:rgba(255,255,255,.85); }
  @media (max-width:1200px){ #map{ height:50vh; } }
  .camera-list{ max-height:200px; overflow-y:auto; }

  .speed-sign { position:fixed; left:50%; top:12px; transform:translateX(-50%) translateY(-20px); z-index:50; pointer-events:none; opacity:0; transition:opacity .2s, transform .25s; }
  .speed-sign.show { opacity:1; transform:translateX(-50%) translateY(0); }
  .speed-sign .sign{ background:#fff; color:#000; border:4px solid #000; border-radius:10px; width:min(46vw, 280px); padding:10px 14px 12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .speed-sign .label{ font-weight:800; letter-spacing:.06em; text-align:center; font-size:14px; margin-bottom:4px; }
  .speed-sign .value{ font-weight:900; text-align:center; font-size:clamp(56px, 16vw, 110px); line-height:1; }
  .speed-sign .capsule{ margin-top:8px; text-align:center; font-size:12px; font-weight:700; letter-spacing:.04em; color:#111; background:#eee; border-radius:999px; padding:4px 10px; display:none; }
  .speed-sign.unknown .capsule{ display:inline-block; }

  .nag-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:60; display:none; }
  .nag{ position:fixed; top:25px; left:50%; transform:translateX(-50%); width:min(92vw, var(--shell-max)); z-index:61; display:none; }
  .nag img{ width:100%; height:auto; display:block; }
</style>
</head>
<body>
  <!-- Background video -->
  <div class="video-bg">
    <video id="bgvid" autoplay loop muted playsinline poster="https://via.placeholder.com/1920x1080?text=Loading+Video">
      <source src="videos/background.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Always-paid overlay art -->
  <div class="overlay-layer" id="overlay">
    <picture id="overlay-paid">
      <source media="(max-width: 1200px)" srcset="images/Copyblockmobile_paid.png">
      <img src="images/Copyblockdesktop_paid.png" alt="SF Speed Cameras">
    </picture>
  </div>

  <!-- Page -->
  <div class="page">
    <div class="content-wrap">
      <div class="app-shell">
        <!-- Buttons -->
        <div class="btn-row mb-3">
          <a id="goPro" href="https://buy.stripe.com/eVq4gA1ra1ptdAT1ZQfbq01" class="btn btn-primary">Go Pro</a>
          <button id="soundBtn" class="btn state-off" type="button" aria-pressed="false">Sound &amp; GPS: Off</button>
        </div>

        <!-- Map -->
        <div id="map" class="mb-3" tabindex="-1"></div>

        <!-- Camera list -->
        <div id="list" class="card mb-3">
          <div class="card-header">Camera Locations</div>
          <ul class="list-group camera-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- SPEED LIMIT sign -->
  <div id="speedSign" class="speed-sign" aria-live="polite" hidden>
    <div class="sign">
      <div class="label">SPEED LIMIT</div>
      <div class="value" id="speedLimitValue">--</div>
      <div class="capsule">SPEED CAMERA ZONE</div>
    </div>
  </div>

  <!-- Trial nag popup -->
  <div id="nagBackdrop" class="nag-backdrop"></div>
  <div id="nag" class="nag">
    <img id="nagImg" src="images/Ad1.png" alt="Upgrade to Pro">
  </div>
  <audio id="adAudio" preload="auto">
    <source src="images/audio/Ad1.mp3" type="audio/mpeg">
  </audio>

  <footer>
    <small>&copy; 2025 SF Speed Cameras • <a href="#" class="text-white-50">Privacy</a> • <a href="#" class="text-white-50">Contact</a></small>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ---------- Constants: GitHub JSON sources ---------- */
const GITHUB_POLES_URL = 'https://raw.githubusercontent.com/DustinY15/sf-speed-alerts/main/data/poles.json';
const GITHUB_CORRIDORS_URL = 'https://raw.githubusercontent.com/DustinY15/sf-speed-alerts/main/data/corridors.json';

/* --- Helpers: hard fail guard so one error doesn’t hide everything --- */
function safe(fn){ try{ fn(); }catch(e){ console.warn(e); } }

/* ---------- Initial scroll behavior ---------- */
safe(()=>{ try { history.scrollRestoration = 'manual'; } catch {} });
safe(()=>{ if (location.hash) { history.replaceState(null, '', location.pathname); } });
safe(()=>{ window.addEventListener('load', () => { window.scrollTo(0, 0); }); });

/* ---------- Video loop height fix ---------- */
safe(()=>{
  const bg = document.getElementById('bgvid');
  bg?.addEventListener('ended', ()=>{ try{ bg.currentTime = 0; bg.play(); }catch(e){} }, false);
  function sizeBG(){ const el=document.querySelector('.video-bg'); if(!el) return; el.style.height = window.innerHeight + 'px'; }
  addEventListener('resize', sizeBG); addEventListener('orientationchange', sizeBG); sizeBG();
});

/* ---------- 33 seed cameras (fallback) ---------- */
const seedCameras = [
  {name:"Fulton Street from 42nd to 43rd Ave",lat:37.7725,lon:-122.5015},
  {name:"Lincoln Way from 27th to 28th Ave",lat:37.7658,lon:-122.4860},
  {name:"Geary Blvd from 7th to 8th Ave",lat:37.7805,lon:-122.4660},
  {name:"Fulton St from 2nd Ave to Arguello Blvd",lat:37.7735,lon:-122.4550},
  {name:"Geary Blvd from Webster to Buchanan St",lat:37.7845,lon:-122.4310},
  {name:"Turk St from Van Ness Ave to Polk St",lat:37.7820,lon:-122.4195},
  {name:"Bay St from Octavia to Gough St",lat:37.8040,lon:-122.4230},
  {name:"Franklin St from Union to Green St",lat:37.8000,lon:-122.4235},
  {name:"Columbus Ave from Lombard to Greenwich St",lat:37.8025,lon:-122.4135},
  {name:"Broadway from Powell to Stockton St",lat:37.7975,lon:-122.4075},
  {name:"The Embarcadero from Green to Battery St",lat:37.8070,lon:-122.4005},
  {name:"Mission St from 8th to 9th St",lat:37.7740,lon:-122.4110},
  {name:"10th St from Harrison to Folsom St",lat:37.7715,lon:-122.4115},
  {name:"9th St from Bryant to Harrison St",lat:37.7725,lon:-122.4090},
  {name:"7th St from Harrison to Folsom St",lat:37.7745,lon:-122.4065},
  {name:"Harrison St from 4th to 5th St",lat:37.7795,lon:-122.4015},
  {name:"Bryant St from 2nd to 3rd St",lat:37.7820,lon:-122.3965},
  {name:"King St (EB only) from 4th to 5th St",lat:37.7775,lon:-122.3940},
  {name:"Market St from Danvers to Douglass St",lat:37.7615,lon:-122.4320},
  {name:"Guerrero St from 19th to 20th St",lat:37.7590,lon:-122.4230},
  {name:"16th St from Bryant St to Potrero Ave",lat:37.7650,lon:-122.4075},
  {name:"San Jose Ave from 29th to 30th St",lat:37.7435,lon:-122.4235},
  {name:"Cesar Chavez St from Folsom to Harrison St",lat:37.7480,lon:-122.4035},
  {name:"Cesar Chavez St from Indiana to Tennessee St",lat:37.7505,lon:-122.3900},
  {name:"3rd St (NB only) from Key to Jamestown Ave",lat:37.7275,lon:-122.3885},
  {name:"Bayshore Blvd (SB only) from 101 off-ramp to Tunnel Ave",lat:37.7100,lon:-122.3990},
  {name:"Geneva Ave from Prague St to Brookdale Ave",lat:37.7130,lon:-122.4405},
  {name:"Mission St from Ottawa Ave to Allison St",lat:37.7145,lon:-122.4400},
  {name:"Alemany Blvd from Farragut to Naglee Ave",lat:37.7320,lon:-122.4425},
  {name:"Ocean Ave from Frida Kahlo Way to Howth St",lat:37.7235,lon:-122.4525},
  {name:"San Jose Ave from Santa Ynez to Ocean Ave",lat:37.7280,lon:-122.4430},
  {name:"Monterey Blvd from Edna to Congo St",lat:37.7315,lon:-122.4650},
  {name:"Sloat Blvd from 41st Ave to Skyline Blvd",lat:37.7355,lon:-122.4980}
];

/* ---------- UI state: tri-state button ---------- */
const soundBtn = document.getElementById('soundBtn');
let audioState = 'off'; // off -> on -> mute
function applyAudioState(){
  soundBtn.classList.remove('state-off','state-on','state-mute');
  if (audioState==='off'){ soundBtn.classList.add('state-off'); soundBtn.textContent='Sound & GPS: Off'; soundBtn.setAttribute('aria-pressed','false'); }
  if (audioState==='on'){  soundBtn.classList.add('state-on');  soundBtn.textContent='Sound & GPS: On';  soundBtn.setAttribute('aria-pressed','true'); }
  if (audioState==='mute'){soundBtn.classList.add('state-mute');soundBtn.textContent='Mute: GPS Only';  soundBtn.setAttribute('aria-pressed','true'); }
}
soundBtn.addEventListener('click', ()=>{
  audioState = (audioState==='off') ? 'on' : (audioState==='on' ? 'mute' : 'off');
  applyAudioState();
  if (audioState!=='off' && !window.__watchId){ startGPS(); }
});
applyAudioState();

/* ---------- Map + list ---------- */
let map, meMarker, meCircle, corridorLayer, camsLayer;
function initMap(cameras){
  map = L.map('map', { zoomControl:true }).setView([37.7749,-122.4194], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

  const camIcon = L.divIcon({
    className: 'cam-dot',
    html: '<div style="width:14px;height:14px;border-radius:50%;background:#e53935;border:2px solid #fff;box-shadow:0 0 6px rgba(0,0,0,.45)"></div>',
    iconSize: [14,14], iconAnchor: [7,7]
  });
  camsLayer = L.layerGroup().addTo(map);
  cameras.forEach(c => L.marker([c.lat,c.lon], { icon: camIcon }).addTo(camsLayer).bindPopup(c.name));

  const ul = document.querySelector('.camera-list');
  ul.innerHTML = '';
  cameras.forEach(c=>{
    const li=document.createElement('li');
    li.className='list-group-item';
    li.textContent=c.name;
    li.addEventListener('click',()=>{
      map.setView([c.lat,c.lon],15,{animate:true});
    });
    ul.appendChild(li);
  });

  document.getElementById('map').setAttribute('tabindex','-1');
  armMapDwell();
}

/* ---------- Live location layers ---------- */
function updateMe(lat, lon, acc=25){
  if (!meMarker){
    meMarker = L.circleMarker([lat,lon], { radius:6, color:'#1976d2', fillColor:'#42a5f5', fillOpacity:1, weight:2 }).addTo(map);
  } else { meMarker.setLatLng([lat,lon]); }
  if (!meCircle){
    meCircle = L.circle([lat,lon], { radius: acc, color:'#42a5f5', fillColor:'#42a5f5', fillOpacity:0.15, weight:0 }).addTo(map);
  } else { meCircle.setLatLng([lat,lon]); meCircle.setRadius(acc); }
}

/* ---------- Audio chains (GPS alerts) ---------- */
const AUDIO_BASE = 'images/audio/';
const STEMS = Array.from({length:11},(_,i)=>`speed_camera_ahead_${i+1}.mp3`);
const TAGS = [
  'brake_the_habit.mp3','this_pic_is_not_for_the_gram.mp3','your_wallet_just_got_a_little_nervous.mp3',
  'no_need_for_a_photo_finish.mp3','your_best_pose_is_slow.mp3','they_go_high_we_go_slow.mp3',
  'keep_it_chill_avoid_the_bill.mp3','slow_is_the_new_fast.mp3','pace_yourself.mp3',
  'less_gas_more_class.mp3','the_smart_money_is_on_slowing_down.mp3','avoid_the_money_shot.mp3',
  'chill_now_thank_yourself_later.mp3','no_rush_no_fuss.mp3','safety_first_bitches.mp3',
  'easy_does_it.mp3','save_the_drama_for_the_drivethru.mp3','your_brakes_called_they_are_ready_to_help.mp3',
  'lets_keep_your_record_clean_ish.mp3','slow_jams_only.mp3','brake_it_till_you_make_it.mp3',
  'slow_and_easy_hotshot.mp3','the_only_rush_is_in_your_head.mp3','drive_like_someone_is_watching.mp3',
  'give_those_brakes_a_little_love.mp3','slow_is_the_flex.mp3','your_future_self_says_thanks.mp3',
  'brakes_are_a_good_good_friend.mp3'
];
let __chainPlaying = false;
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function playChain(files){
  if(!files.length || __chainPlaying) return;
  if (audioState==='off') return;
  __chainPlaying = true;
  const a = new Audio(AUDIO_BASE + files[0]);
  a.play().catch(()=>{ __chainPlaying=false; });
  a.onended = ()=>{
    const rest = files.slice(1);
    if (rest.length){ __chainPlaying=false; playChain(rest); }
    else setTimeout(()=>{ __chainPlaying=false; }, 200);
  };
}
function playGeofenceAlert(){ playChain([pick(STEMS), pick(TAGS)]); }

/* ---------- SPEED LIMIT sign ---------- */
const SPEED_LIMITS = {};
let currentZone = null;
function showSpeedSign(limit){
  const box = document.getElementById('speedSign'); const val = document.getElementById('speedLimitValue');
  if (!box || !val) return;
  if (Number.isFinite(limit)){ val.textContent = String(limit); box.classList.remove('unknown'); }
  else { val.textContent = '--'; box.classList.add('unknown'); }
  box.hidden = false; box.classList.add('show');
}
function hideSpeedSign(){ const box=document.getElementById('speedSign'); if(!box) return; box.classList.remove('show'); setTimeout(()=>{box.hidden=true;},250); }

/* ---------- ArcGIS fallback (kept) ---------- */
const ARCGIS_LAYER_URL = 'https://services.arcgis.com/Zs2aNLFN00jrS4gG/arcgis/rest/services/Proposed_Automated_Speed_Enforcement_Locations_WFL1/FeatureServer/4';
const NAME_FIELDS  = ['CORRIDOR','Name','NAME','Segment','SEGMENT','Corridor','name','NAME_STR'];
const SPEED_FIELDS = ['SPEEDLIMIT','SPEED_LIMIT','SpeedLimit','Speed_Limit','POSTED','POSTED_SPEED','speed','limit'];
const CACHE_KEY = 'sf_ase_corridors_v3';
let CORRIDOR_INDEX = new Map(); // name -> { line, buffer, speed, dir }

function getProp(o,keys){ for(const k of keys){ if(o && o[k]!=null && o[k]!=='') return o[k]; } return null; }
function norm(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
function toRad(d){ return d*Math.PI/180; }
function nearAnyPoint([lng,lat], points, meters = 150){
  for (const [clng,clat] of points){
    const dLat = toRad(lat - clat), dLon = toRad(lng - clng);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat))*Math.cos(toRad(clat))*Math.sin(dLon/2)**2;
    const d = 6371000 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    if (d <= meters) return true;
  }
  return false;
}

async function fetchLiveCorridors(){
  const url = `${ARCGIS_LAYER_URL}/query?where=1%3D1&outFields=*&outSR=4326&f=geojson`;
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error('ArcGIS down');
  return await r.json();
}
function loadCache(){ try{ const s=localStorage.getItem(CACHE_KEY); return s?JSON.parse(s):null; }catch{ return null; } }
function saveCache(fc){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(fc)); }catch{} }

/* ---------- GitHub JSON: robust fetch/parse ---------- */
async function fetchCleanJson(url){
  const res = await fetch(url, { cache:'no-store' });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText} @ ${url}`);
  const text = await res.text();
  const cleaned = text
    .replace(/\uFEFF/g, '')                // BOM
    .replace(/[“”]/g, '"')                 // smart double
    .replace(/[‘’]/g, "'");                // smart single
  try{ return JSON.parse(cleaned); }
  catch(e){ console.error('JSON parse error for', url, e, 'Head:', cleaned.slice(0,220)); throw e; }
}

/* ---------- Local corridors from GitHub (preferred) ---------- */
async function ensureCorridorsFromLocal(cameraPoints){
  let fc;
  try{
    fc = await fetchCleanJson(GITHUB_CORRIDORS_URL);
  }catch(e){
    console.warn('Local corridors failed, will try ArcGIS fallback.', e);
    return false;
  }
  if (!fc || !Array.isArray(fc.features)){
    console.warn('Local corridors missing features; ArcGIS fallback will be used.');
    return false;
  }

  CORRIDOR_INDEX.clear();
  const filtered = [];
  for (const feat of fc.features){
    const props = feat.properties || {};
    let geom = feat.geometry;
    if (!geom) continue;

    // accept LineString/MultiLineString/Polygon/MultiPolygon
    if (geom.type === 'MultiLineString'){
      geom = { type:'LineString', coordinates: [...geom.coordinates].sort((a,b)=>b.length-a.length)[0] };
    } else if (geom.type === 'Polygon'){
      // convert ring to LineString for distance calc; keep polygon for display via buffer
      const ring = geom.coordinates && geom.coordinates[0];
      if (ring) geom = { type:'LineString', coordinates: ring };
    } else if (geom.type === 'MultiPolygon'){
      const ring = geom.coordinates && geom.coordinates[0] && geom.coordinates[0][0];
      if (ring) geom = { type:'LineString', coordinates: ring };
    }
    if (geom.type !== 'LineString') continue;

    // Optional spatial filter: only corridors that pass near any camera
    const spatialMatches = geom.coordinates.some(([lng,lat]) => nearAnyPoint([lng,lat], cameraPoints, 150));
    if (!spatialMatches) continue;

    const rawName = getProp(props, NAME_FIELDS) || props.id || props.ID || null;
    const name = (rawName ? String(rawName) : `Corridor ${filtered.length+1}`).trim();

    const speed = Number(getProp(props, SPEED_FIELDS));
    const dir = props.Direction || props.DIRECTION || props.dir || null;

    // Build buffer polygon for visual & fast point-in-polygon
    let buffered = null; try{ buffered = turf.buffer(geom, 20, { units:'meters' }); }catch{}

    CORRIDOR_INDEX.set(name, { line: geom, buffer: buffered, speed: Number.isFinite(speed)?speed:null, dir });
    if (Number.isFinite(speed)) SPEED_LIMITS[name] = speed;

    if (buffered){
      filtered.push({ type:'Feature', geometry: buffered.geometry, properties: { name } });
    }
  }

  if (map){
    if (corridorLayer) corridorLayer.remove();
    corridorLayer = L.geoJSON({ type:'FeatureCollection', features: filtered }, {
      style: { color: null, weight: 0, fillColor:'#FFCC33', fillOpacity:0.28 }
    }).addTo(map);
  }
  return true;
}

/* ---------- ArcGIS corridors (fallback) ---------- */
async function ensureCorridorsFromArcGIS(cameraPoints){
  let fc = loadCache();
  if(!fc){ try { fc = await fetchLiveCorridors(); saveCache(fc); } catch { return false; } }
  else { fetchLiveCorridors().then(saveCache).catch(()=>{}); }

  CORRIDOR_INDEX.clear();
  const filtered = [];
  for (const feat of (fc.features || [])){
    const props = feat.properties || {};
    let geom = feat.geometry;
    if (!geom) continue;

    if (geom.type === 'MultiLineString'){
      geom = { type:'LineString', coordinates: [...geom.coordinates].sort((a,b)=>b.length-a.length)[0] };
    }
    if (geom.type !== 'LineString') continue;

    const rawName = getProp(props, NAME_FIELDS);
    const name = rawName ? String(rawName).trim() : null;
    if (!name) continue;

    const spatialMatches = geom.coordinates.some(([lng,lat]) => nearAnyPoint([lng,lat], cameraPoints, 150));
    if (!spatialMatches) continue;

    const speed = Number(getProp(props, SPEED_FIELDS));
    let buffered = null; try{ buffered = turf.buffer(geom, 20, { units:'meters' }); }catch{}
    CORRIDOR_INDEX.set(name, { line: geom, buffer: buffered, speed: Number.isFinite(speed)?speed:null, dir: props.Direction || props.DIRECTION || null });
    if (Number.isFinite(speed)) SPEED_LIMITS[name] = speed;

    if (buffered){
      filtered.push({ type:'Feature', geometry: buffered.geometry, properties: { name } });
    }
  }

  if (map){
    if (corridorLayer) corridorLayer.remove();
    corridorLayer = L.geoJSON({ type:'FeatureCollection', features: filtered }, {
      style: { color: null, weight: 0, fillColor:'#FFCC33', fillOpacity:0.28 }
    }).addTo(map);
  }
  return true;
}

/* ---------- Geofencing with buffer + bearing + dwell ---------- */
const ENTER_M = 25, EXIT_M = 45, MAX_ACC_M = 30, MIN_SPEED_MPS = 2.2, COOLDOWN_MS = 45000;
const insideNow = new Set(), lastAlertAt = new Map();
let lastUserInteract = 0;
const FOLLOW_DWELL_MS = 15000;

function armMapDwell(){
  if (!map) return;
  ['dragstart','zoomstart','mousedown','touchstart'].forEach(ev=>{
    map.on(ev, ()=>{ lastUserInteract = Date.now(); });
  });
}

function passesGates(coords){
  const {accuracy,speed}=coords;
  if(accuracy && accuracy>MAX_ACC_M) return false;
  if(typeof speed==='number' && speed<MIN_SPEED_MPS) return false;
  return true;
}
function headingMatches(headingDeg, dir){
  if(!dir || typeof headingDeg!=='number') return true;
  const mapDir={NB:0,N:0,EB:90,E:90,SB:180,S:180,WB:270,W:270};
  const tgt = mapDir[String(dir).toUpperCase()] ?? null; if(tgt==null) return true;
  const diff = Math.min(Math.abs(headingDeg-tgt), 360-Math.abs(headingDeg-tgt));
  return diff <= 60;
}
function inCorridorBuffer(e, lngLat){
  if (!e || !e.buffer) return false;
  return turf.booleanPointInPolygon(turf.point(lngLat), e.buffer);
}
function corridorDistanceM(e, lngLat){
  if (e && e.line) return turf.pointToLineDistance(turf.point(lngLat), e.line, { units:'meters' });
  return Infinity;
}
function headingAlignsWithLine(e, lngLat, userHeading){
  if (!e || !e.line || typeof userHeading !== 'number') return true;
  const pt = turf.point(lngLat);
  const snapped = turf.nearestPointOnLine(e.line, pt);
  const idx = snapped.properties.index;
  const coords = e.line.coordinates;
  const a = coords[Math.max(0, idx - 1)];
  const b = coords[Math.min(coords.length - 1, idx + 1)];
  if (!a || !b) return true;
  const segBearing = turf.bearing(turf.point(a), turf.point(b));
  const user = ((userHeading % 360) + 360) % 360;
  const seg  = ((segBearing  % 360) + 360) % 360;
  const diff = Math.min(Math.abs(user - seg), 360 - Math.abs(user - seg));
  return diff <= 60;
}

function startGPS(){
  if(!('geolocation' in navigator)) return;
  if(window.__watchId!=null) return;

  window.__watchId = navigator.geolocation.watchPosition(async pos=>{
    const {latitude,longitude,accuracy,speed,heading}=pos.coords;
    if(!passesGates(pos.coords)) return;

    const now=Date.now(), lngLat=[longitude,latitude];
    updateMe(latitude, longitude, accuracy || 25);

    if (map){
      const since = now - lastUserInteract;
      if (since > FOLLOW_DWELL_MS){
        map.panTo([latitude, longitude], { animate:true, duration: 1.25 });
      }
    }

    for (const [name, ent] of CORRIDOR_INDEX.entries()){
      if (ent.dir && !headingMatches(heading, ent.dir)) continue;

      const inside = inCorridorBuffer(ent, lngLat);
      const dM = inside ? 0 : corridorDistanceM(ent, lngLat);

      const wasIn = insideNow.has(name);
      const entering = (!wasIn) && (inside || dM <= ENTER_M);
      const exiting  = wasIn && (!inside && dM > EXIT_M);

      if (entering) {
        const last = lastAlertAt.get(name)||0;
        if (now-last > COOLDOWN_MS) {
          playGeofenceAlert();
          showSpeedSign(ent.speed ?? null);
          lastAlertAt.set(name, now);
        }
        insideNow.add(name);
        currentZone = name;
      } else if (exiting) {
        insideNow.delete(name);
        if (currentZone === name){ currentZone = null; hideSpeedSign(); }
      }
    }
  }, err=>console.warn('Geolocation error', err),
  { enableHighAccuracy:true, maximumAge:500, timeout:8000 });
}

/* ---------- Trial nag ---------- */
const nagBackdrop = document.getElementById('nagBackdrop');
const nag = document.getElementById('nag');
const nagImg = document.getElementById('nagImg');
const adAudio = document.getElementById('adAudio');

function showNag(){
  nagBackdrop.style.display='block';
  nag.style.display='block';
  adAudio.currentTime = 0;
  adAudio.play().catch(()=>{});
  setTimeout(hideNag, 25000);
}
function hideNag(){
  nagBackdrop.style.display='none';
  nag.style.display='none';
  adAudio.pause();
}
nagBackdrop.addEventListener('click', hideNag);
nagImg.addEventListener('click', ()=>{ window.location.href = document.getElementById('goPro').href; });
function scheduleNags(){
  setTimeout(()=>{ showNag(); }, 120000);
  setInterval(()=>{ showNag(); }, 30*60*1000);
}

/* ---------- Prefer precise poles from GitHub ---------- */
async function loadPoles(){
  try{
    const gj = await fetchCleanJson(GITHUB_POLES_URL);
    const cams = [];
    const feats = (gj && gj.type==='FeatureCollection') ? gj.features : (gj && gj.type==='Feature' ? [gj] : []);
    for (const f of feats){
      if (!f.geometry || f.geometry.type!=='Point') continue;
      const [lng,lat] = f.geometry.coordinates || [];
      const name = (f.properties && f.properties.name) ? String(f.properties.name) : 'Speed Camera';
      if (typeof lat==='number' && typeof lng==='number'){
        cams.push({ name, lat, lon: lng });
      }
    }
    if (cams.length) return cams;
  }catch(e){
    console.warn('Poles from GitHub failed, using seed set.', e);
  }
  return null;
}

/* ---------- Boot ---------- */
(async function boot(){
  const poles = await loadPoles();
  const cameras = poles || seedCameras;
  initMap(cameras);

  const camPoints = cameras.map(c=>[c.lon, c.lat]);
  const okLocal = await ensureCorridorsFromLocal(camPoints);
  if (!okLocal){
    await ensureCorridorsFromArcGIS(camPoints); // fallback
  }

  scheduleNags();
})();
</script>
</body>
</html>
