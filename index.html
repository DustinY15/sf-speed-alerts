<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover"/>
<meta name="format-detection" content="telephone=no,address=no,email=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="manifest" id="app-manifest" href="">

<!-- Force HTTPS for real GPS; set BASE for root domain; true viewport height -->
<script>
  // 1) HTTPS (required by Geolocation on device)
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    location.replace('https://' + location.hostname + location.pathname + location.search + location.hash);
  }
  // 2) BASE: keep GH Pages support, default to root for speedwarn.com
  (function () {
    const REPO = 'sf-speed-alerts';
    const path = location.pathname.replace(/\/+$/, '');
    const onRepo = location.hostname.endsWith('github.io') && path.startsWith('/' + REPO);
    let base = onRepo ? ('/' + REPO) : '';
    if (!base) {
      const parts = location.pathname.split('/');
      const idx = parts.lastIndexOf(REPO);
      if (idx > -1) base = '/' + parts.slice(1, idx + 1).join('/');
    }
    window.BASE = base || '';               // root for speedwarn.com
    window.DATA_BASE = (base || '') + '/data';
    window.DEV = /[?&]dev=1\b/.test(location.search);
    const m = document.getElementById('app-manifest');
    if (m) m.setAttribute('href', (base || '') + '/manifest.json');
  })();
  // 3) Use the real viewport height on iOS to avoid the big gap
  (function setVH(){
    function apply(){
      var h = Math.round((window.visualViewport?.height || window.innerHeight));
      document.documentElement.style.setProperty('--vhpx', h + 'px');
    }
    apply();
    addEventListener('resize', apply, {passive:true});
    window.visualViewport && window.visualViewport.addEventListener('resize', apply, {passive:true});
    addEventListener('orientationchange', () => setTimeout(apply, 60), {passive:true});
  })();
</script>

<title>SF Speed Cameras - Alerts & Map</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<link rel="preload" as="audio" href="images/audio/Ad1.mp3" type="audio/mpeg">
<link rel="preload" as="audio" href="images/audio/beep.mp3" type="audio/mpeg">

<style>
  :root{
    --paid-offset-mobile: 220px;
    --paid-offset-desktop: 330px;
    --overlay-top: 10px;
    --shell-max: 520px;
    --overlay-paid-offset: -36px;
  }
  html, body { height:100%; }
  body{
    margin:0; background:#0b0b0b; color:#fff;
    font-family:system-ui,-apple-system,Arial; font-weight:600;
    display:flex; flex-direction:column; overflow-x:hidden;
  }
  .page { flex:1 0 auto; position:relative; }
  footer { flex:0 0 auto; padding:14px 0 calc(18px + env(safe-area-inset-bottom)); text-align:center; }

  /* Background video */
  .video-bg{ position:fixed; left:0; top:0; width:100vw; height:var(--vhpx, 100vh); z-index:-3; overflow:hidden; }
  .video-bg video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; }

  /* Overlay */
  .overlay-layer{ position:absolute; left:0; top:var(--overlay-top); width:100%; z-index:2; pointer-events:none; }
  .overlay-layer img{ width:100%; height:auto; display:block; }
  #ovPaidImg{ transform:translateY(var(--overlay-paid-offset)); will-change:transform; }

  /* Content */
  .content-wrap{ position:relative; padding:16px 20px 24px; z-index:3; margin-top:var(--paid-offset-mobile); }
  @media (min-width:1200px){ .content-wrap{ margin-top:var(--paid-offset-desktop);} }
  .app-shell{ width:min(94vw, var(--shell-max)); margin:0 auto; }
  .btn-match{ line-height:1.25; padding:.55rem 1rem; font-weight:700; }

  /* Warmup states */
  #warmup.btn-off { background:#b02a37; border-color:#b02a37; color:#fff; }
  #warmup.btn-on { background:#198754; border-color:#198754; color:#fff; }
  #warmup.btn-mute { background:#b89b00; border-color:#b89b00; color:#111; }

  /* Map */
  #map{
    width:100%;
    height:clamp(320px, calc(var(--vhpx, 700px) * 0.62), 78vh);
    border:1px solid #ddd; border-radius:8px; background:rgba(255,255,255,.9);
  }
  @media (max-width:430px){ #map{ height:clamp(300px, calc(var(--vhpx, 700px) * 0.58), 70vh); } }

  /* List */
  .camera-list{ max-height:260px; overflow-y:auto; }
  @media (max-width:430px){ .camera-list{ max-height:220px; } }

  /* Misc UI */
  .loc-dot{ width:14px; height:14px; border-radius:50%; background:#2a6bf4; border:2px solid #fff; box-shadow:0 0 0 6px rgba(42,107,244,.25); }
  .leaflet-popup-content a{ text-decoration:none; pointer-events:none; color:inherit; }
  .dev-badge{ position:fixed; left:10px; bottom:10px; z-index:9999; background:#8b5cf6; color:#fff; padding:6px 10px; border-radius:999px; font:700 12px/1 system-ui,-apple-system,Arial; box-shadow:0 6px 18px rgba(0,0,0,.35); display:none; }
  .dev-badge.show{ display:inline-block; }

  /* Speed sign */
  .speed-sign { position:fixed; left:50%; top:12px; transform:translateX(-50%) translateY(-20px); z-index:70; pointer-events:none; opacity:0; transition:opacity .2s, transform .25s; }
  .speed-sign.show { opacity:1; transform:translateX(-50%) translateY(0); }
  .speed-sign .sign{ background:#fff; color:#000; border:4px solid #000; border-radius:10px; width:min(46vw, 280px); padding:10px 14px 12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .speed-sign .label{ font-weight:800; letter-spacing:.06em; text-align:center; font-size:14px; margin-bottom:4px; }
  .speed-sign .value{ font-weight:900; text-align:center; font-size:clamp(56px, 16vw, 110px); line-height:1; }
  .speed-sign .capsule{ margin-top:8px; text-align:center; font-size:12px; font-weight:700; letter-spacing:.04em; color:#111; background:#eee; border-radius:999px; padding:4px 10px; display:none; }
  .speed-sign.unknown .capsule{ display:inline-block; }
  .speed-sign.fallback .sign{ opacity:.85; }

  .nag-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:60; }
  .nag-wrap{ position:relative; transform:translateY(30px); }
  .nag-img{ max-width:min(90vw, 540px); border-radius:14px; box-shadow:0 25px 60px rgba(0,0,0,.55); }
  .nag-count{ position:absolute; bottom:10px; right:14px; background:rgba(0,0,0,.6); color:#fff; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; }

  .toast-container{ position:fixed; right:12px; bottom:calc(12px + env(safe-area-inset-bottom)); z-index:10000; }
</style>
</head>

<body>
  <div class="video-bg" aria-hidden="true">
    <video id="bgvid" autoplay loop muted playsinline preload="auto" crossorigin="anonymous" poster="https://via.placeholder.com/1920x1080?text=Loading+Video">
      <source id="bgvidSrc" src="" type="video/mp4">
    </video>
  </div>

  <div class="overlay-layer" id="overlay" aria-hidden="true">
    <picture id="overlay-paid">
      <source id="ovPaidSrcM" media="(max-width: 1200px)" srcset="">
      <img id="ovPaidImg" src="" alt="SF Speed Cameras (Paid)" decoding="async" fetchpriority="low">
    </picture>
  </div>

  <div class="page">
    <div class="content-wrap">
      <div class="app-shell">
        <div class="d-flex gap-2 align-items-center mb-3">
          <a id="payCTA" class="btn btn-primary btn-match" href="#" aria-label="Upgrade to Pro" rel="noopener">Go Pro</a>
          <button id="warmup" class="btn btn-match btn-off" aria-pressed="false" aria-live="polite">Sound &amp; GPS: Off</button>
          <button id="testSound" class="btn
