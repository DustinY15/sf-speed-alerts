<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="format-detection" content="telephone=no,address=no,email=no">
<title>SpeedWarn – Map (Fix)</title>

<!-- Force HTTPS so Geolocation works -->
<script>
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    location.replace('https://' + location.hostname + location.pathname + location.search + location.hash);
  }
</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script defer src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
  :root{
    /* real viewport height populated by JS */
    --vhpx: 100vh;
    /* pull content up to kill the middle gap */
    --lift-offset: 400px;
  }
  html,body{margin:0;padding:0;background:#0b0b0b;color:#fff;font:600 16px/1.35 system-ui,-apple-system,Arial;}
  .wrap{max-width:560px;margin:0 auto;padding:16px 14px 24px;}
  .hero{position:relative;margin-top:calc(16px - var(--lift-offset));}
  .title{font-weight:800;font-size:20px;margin:8px 0 10px;}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:12px;}
  button{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .on{background:#198754;color:#fff}
  .off{background:#b02a37;color:#fff}
  .mute{background:#b89b00;color:#111}
  #map{height:calc(var(--vhpx, 700px)*0.60); border-radius:12px; overflow:hidden; background:#fff}
  .list{margin-top:12px;background:#111;border-radius:12px;overflow:hidden}
  .list h3{margin:0;padding:10px 12px;background:#181818;font-size:14px;letter-spacing:.03em}
  .list ul{list-style:none;margin:0;padding:0;max-height:220px;overflow:auto}
  .list li{padding:10px 12px;border-top:1px solid #222;cursor:pointer}
  .list li:active{background:#222}
  .note{opacity:.75;font-weight:600;font-size:12px;margin-top:10px}
</style>

<script>
  // Real viewport height -> CSS var (fixes iOS/Chrome UI bars issues)
  (function setVH(){
    function apply(){
      var h = Math.round((window.visualViewport?.height || window.innerHeight));
      document.documentElement.style.setProperty('--vhpx', h + 'px');
    }
    apply();
    addEventListener('resize', apply, {passive:true});
    window.visualViewport && window.visualViewport.addEventListener('resize', apply, {passive:true});
    addEventListener('orientationchange', () => setTimeout(apply, 60), {passive:true});
  })();
</script>
</head>
<body>
  <div class="wrap hero">
    <div class="row">
      <button id="warm" class="off">Sound & GPS: Off</button>
      <button id="mute" class="mute">Mute (GPS Only)</button>
    </div>
    <div id="map" role="application" aria-label="Speed camera map"></div>

    <div class="list" aria-live="polite">
      <h3>Camera Locations</h3>
      <ul id="camList"></ul>
    </div>

    <div class="note" id="status">Loading cameras…</div>
  </div>

<script>
(() => {
  const BASE = '';
  const DATA_BASE = `${BASE}/data`;
  const statusEl = document.getElementById('status');
  const listEl = document.getElementById('camList');

  // Map init (zoom 14 so it’s readable)
  const map = L.map('map', { zoomControl: true }).setView([37.7749, -122.4194], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  const poleLayer = L.layerGroup().addTo(map);
  const dotIcon = L.divIcon({ className: 'loc-dot', html:'', iconSize:[1,1] });
  const userIcon = L.divIcon({ className: 'user-dot', html:'', iconSize:[1,1] });

  // Nice visible user dot
  const userDot = L.circleMarker([37.7749,-122.4194], {
    radius:7, color:'#fff', weight:2, fillColor:'#2a6bf4', fillOpacity:1
  });

  // Fallback cameras (used only if /data/poles.json fails)
  const FALLBACK = [
    {name:'Geary Blvd @ 7th–8th Ave', lat:37.7809, lon:-122.4664},
    {name:'Fulton St @ Arguello',     lat:37.7742, lon:-122.4586},
    {name:'Market St @ Douglass',     lat:37.7606, lon:-122.4389},
    {name:'10th St @ Folsom',         lat:37.7720, lon:-122.4117},
    {name:'The Embarcadero @ Battery',lat:37.8022, lon:-122.3996}
  ];

  // Util: fetch JSON with cache-buster
  async function getJSON(u){
    const sep = u.includes('?') ? '&' : '?';
    const r = await fetch(u + sep + 'v=' + Date.now(), {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  function renderList(cams){
    listEl.innerHTML = '';
    cams.forEach(c => {
      const li = document.createElement('li');
      li.textContent = c.name;
      li.addEventListener('click', () => {
        map.setView([c.lat, c.lon], 15);
      });
      listEl.appendChild(li);
    });
  }

  function renderMarkers(cams){
    poleLayer.clearLayers();
    const latlngs = [];
    cams.forEach(c => {
      const m = L.marker([c.lat, c.lon], {
        icon: L.icon({
          iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><circle cx="14" cy="14" r="10" fill="#d62828" stroke="white" stroke-width="3"/></svg>'),
          iconSize:[28,28], iconAnchor:[14,14]
        })
      }).addTo(poleLayer);
      m.bindPopup(c.name);
      latlngs.push([c.lat, c.lon]);
    });
    if (latlngs.length) {
      map.fitBounds(L.latLngBounds(latlngs).pad(0.2));
      // then nudge to a readable zoom
      if (map.getZoom() < 14) map.setZoom(14);
    }
  }

  async function loadCameras(){
    try {
      const poles = await getJSON(`${DATA_BASE}/poles.json`);
      const feats = (poles.features || []).filter(f => f.geometry?.type === 'Point');
      const cams = feats.map(f => {
        const [lon, lat] = f.geometry.coordinates;
        return { name: f.properties?.name || 'Speed Camera', lat, lon };
      });
      if (!cams.length) throw new Error('empty');
      statusEl.textContent = 'Loaded cameras.';
      renderMarkers(cams);
      renderList(cams);
    } catch(e) {
      statusEl.textContent = 'Using built-in camera list (data folder not found).';
      renderMarkers(FALLBACK);
      renderList(FALLBACK);
    }
  }

  // GPS controls
  let mode = 'off';
  const warmBtn = document.getElementById('warm');
  const muteBtn = document.getElementById('mute');
  let watchId = null;

  function setButtons(){
    warmBtn.className = mode === 'on' ? 'on' : 'off';
    warmBtn.textContent = mode === 'on' ? 'Sound & GPS: On' : 'Sound & GPS: Off';
    muteBtn.className = 'mute';
  }

  function startGPS(){
    if (!('geolocation' in navigator)) { statusEl.textContent = 'GPS not supported on this device.'; return; }
    if (watchId != null) return;
    userDot.addTo(map);
    watchId = navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      // Always show the dot so you see movement even while accuracy warms up
      userDot.setLatLng([latitude, longitude]);
    }, err => {
      statusEl.textContent = 'Location blocked. Please allow location for speedwarn.com';
    }, { enableHighAccuracy:true, maximumAge:500, timeout:8000 });
  }
  function stopGPS(){
    if (watchId != null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    try { map.removeLayer(userDot); } catch {}
  }

  warmBtn.addEventListener('click', () => {
    mode = mode === 'on' ? 'off' : 'on';
    setButtons();
    if (mode === 'on') startGPS(); else stopGPS();
  });
  muteBtn.addEventListener('click', () => {
    // GPS only; no audio pipeline in this minimal fix
    mode = 'mute';
    setButtons();
    startGPS();
    statusEl.textContent = 'GPS active (muted).';
  });

  setButtons();
  loadCameras();
})();
</script>
</body>
</html>
